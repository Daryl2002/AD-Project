<!DOCTYPE html>
<html>

<head>
    <title>TTMS - Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="Styles/loginStyle.css">
</head>

<body>

    <div class="main-wrapper">
        <header class="top-bar">
            <div class="welcome-text">WELCOME!</div>
            <div class="faculty-text">
                Fakulti Komputeran
            </div>
        </header>

        <main class="login-container">
            <div class="logo-container">
                <img id="utm-logo" src="Logo/UTM-LOGO.png" alt="UTM Logo">
            </div>

            <div class="login-box">
                <h2>Sign in to TTMS</h2>
                <p class="subtitle">Enter your credentials to access the system</p>

                <div class="input-group">
                    <label for="login">UserID</label>
                    <input type="text" id="login" class="input-field" value="A24CS0064" placeholder="Enter your ID">
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="input-field" value="020620120897"
                        placeholder="••••••••">
                </div>

                <button class="login-button" id="btnLogin">LOGIN</button>
            </div>
        </main>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        // TTMS Web Service Base URL
        const BASE_URL = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi";

        $("#btnLogin").click(function () {

            const loginId = $("#login").val();
            const password = $("#password").val();

            if (!loginId || !password) {
                alert("Please enter both UserID and Password.");
                return;
            }

            const authUrl = `${BASE_URL}?entity=authentication&login=${loginId}&password=${password}`;

            // 1. Perform Authentication
            fetch(authUrl)
                .then(res => res.json())
                .then(jsonInst => {

                    if (!Array.isArray(jsonInst) || jsonInst.length === 0 || !jsonInst[0].session_id) {
                        throw new Error("Invalid credential or authentication API error.");
                    }

                    alert("Successfully logged in to the system!");
                    const userData = jsonInst[0];

                    // Save user session data to localStorage
                    localStorage.setItem("TTMSFC_userSession", JSON.stringify(userData));

                    // 2. Determine Role via secondary API check
                    determineUserRole(userData);
                })
                .catch(err => {
                    alert("Invalid credential or connection error!");
                    console.error("Login Error:", err);
                });
        });

        // ===============================================
        // FUNCTION: Determine Role and Redirect
        // ===============================================
        function determineUserRole(userData) {

            const userSessionId = userData.session_id;
            const adminAuthUrl = `http://web.fc.utm.my/ttms/auth-admin.php?session_id=${userSessionId}`;

            // 1️⃣ Try to escalate to Admin
            fetch(adminAuthUrl)
                .then(res => res.json())
                .then(adminData => {

                    if (Array.isArray(adminData) && adminData.length > 0 && adminData[0].session_id) {

                        // ✅ ADMIN CONFIRMED
                        console.log("Admin access granted.");

                        // Save admin session separately
                        localStorage.setItem(
                            "TTMSFC_adminSession",
                            JSON.stringify(adminData[0])
                        );

                        window.location.replace("AdminMain.html");
                        return;
                    }

                    // ❌ Not admin → check student
                    checkStudentOrLecturer(userData);
                })
                .catch(err => {
                    console.warn("Admin check failed, fallback to user role.", err);
                    checkStudentOrLecturer(userData);
                });
        }
        function checkStudentOrLecturer(userData) {

            const loginName = userData.login_name;
            const studentCheckUrl =
                `${BASE_URL}?entity=pelajar_subjek&no_matrik=${loginName}`;

            fetch(studentCheckUrl)
                .then(res => res.json())
                .then(subjects => {

                    if (Array.isArray(subjects) && subjects.length > 0) {
                        console.log("Role: STUDENT");
                        window.location.replace("Main.html");
                    } else {
                        console.log("Role: LECTURER");
                        window.location.replace("MainLecturer.html");
                    }
                })
                .catch(err => {
                    console.error("Role detection failed, defaulting to student.", err);
                    window.location.replace("Main.html");
                });
        }

    </script>
</body>

</html>