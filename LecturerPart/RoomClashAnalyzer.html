<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Room Clash Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <script src="../Authenticate.js"></script>
  <script src="../CacheUtil.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

  <style>
    body {
      font-size: 14px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th {
      background: #fff3a0;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .clash-row {
      background-color: #ffe1e1;
    }

    td,
    th {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
      white-space: nowrap;
    }
  </style>
</head>

<body class="w3-container">

  <h3 class="w3-center w3-text-blue">
    Room Clash Analyzer – Ruang & Masa
  </h3>

  <div class="w3-panel w3-light-grey w3-round">
    <b>Sesi / Semester:</b>
    <span id="sessionSem">Loading…</span>
  </div>

  <div class="w3-responsive">
    <table class="w3-table-all">
      <thead>
        <tr>
          <th>Bil.</th>
          <th>Kod Ruang</th>
          <th>Nama Ruang</th>
          <th>Nama Singkatan</th>
          <th>Kod Fakulti/Jabatan</th>
          <th>Hari</th>
          <th>Masa</th>
          <th>Subjek</th>
        </tr>
      </thead>
      <tbody id="resultBody">
        <tr>
          <td colspan="8" class="w3-center">Loading data…</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    /* ================= STATE ================= */
    const state = {
      sesi: window.parent.currentSesi,
      semester: window.parent.currentSemester,
      lecturerCache: {}
    };

    $("#sessionSem").text(`${state.sesi} | Semester ${state.semester}`);

    /* ================= INIT ================= */
    $(document).ready(loadRooms);

    /* ================= LOAD ROOMS (SEQUENTIAL) ================= */
    async function loadRooms() {
      try {
        $("#resultBody").html(`<tr><td colspan="8" class="w3-center">Starting scan...</td></tr>`);

        // 1. Fetch Room List
        const rooms = await cachedFetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=ruang&kod_fakulti=fsksm");

        let allSchedules = [];
        let count = 0;
        const total = rooms.length;

        // 2. Sequential Fetch to match Vue reference & prevent server overwhelm
        for (const room of rooms) {
          count++;
          // Optional: Update progress every few items to avoid UI flicker overkill
          if (count % 5 === 0 || count === 1) {
            $("#resultBody").html(`<tr><td colspan="8" class="w3-center">Scanning room ${count}/${total}: ${room.kod_ruang}...</td></tr>`);
          }

          try {
            const list = await cachedFetch(
              `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_ruang&sesi=${state.sesi}&semester=${state.semester}&kod_ruang=${room.kod_ruang}`
            );

            if (Array.isArray(list)) {
              const mapped = list.map(j => ({
                room,
                hari: j.hari,
                masa: j.masa,
                tarikh_mula: j.tarikh_mula,
                kod_perkara: j.kod_perkara,
                subjek: j.subjek
              }));
              allSchedules.push(...mapped);
            }
          } catch (err) {
            console.warn(`Failed to load ${room.kod_ruang}`, err);
          }
        }

        detectClashes(allSchedules);

      } catch (e) {
        showError(e);
      }
    }

    /* ================= CLASH DETECTION ================= */
    function detectClashes(rows) {
      const map = {};

      rows.forEach(item => {
        // Ensure valid keys
        if (!item.tarikh_mula || item.masa == null || item.hari == null) return;

        // Group by Date + Time + Day + Room (Scope is global list, so need Room in key)
        const key = `${item.room.kod_ruang}|${item.tarikh_mula}|${item.masa}|${item.hari}`;

        if (!map[key]) map[key] = [];

        // CHECK FOR DUPLICATES (Refined from Vue Logic)
        const isDuplicate = map[key].some(existing => {
          const samePerkara = item.kod_perkara && existing.kod_perkara === item.kod_perkara;

          const sameSubjekSeksyen =
            item.subjek && existing.subjek &&
            item.subjek.kod_subjek === existing.subjek.kod_subjek &&
            item.subjek.seksyen === existing.subjek.seksyen;

          return samePerkara || sameSubjekSeksyen;
        });

        if (!isDuplicate) {
          map[key].push(item);
        }
      });

      // Filter groups > 1
      const clashes = Object.values(map)
        .filter(g => g.length > 1)
        .flat();

      renderTable(clashes);
    }

    /* ================= FORMATTERS ================= */
    const TIME_MAP = {
      2: '08:00 AM - 08:50 AM',
      3: '09:00 AM - 09:50 AM',
      4: '10:00 AM - 10:50 AM',
      5: '11:00 AM - 11:50 AM',
      6: '12:00 PM - 12:50 PM',
      7: '01:00 PM - 01:50 PM',
      8: '02:00 PM - 02:50 PM',
      9: '03:00 PM - 03:50 PM',
      10: '04:00 PM - 04:50 PM',
      11: '05:00 PM - 05:50 PM',
      12: '06:00 PM - 06:50 PM',
      13: '07:00 PM - 07:50 PM',
      14: '08:00 PM - 08:50 PM',
      15: '09:00 PM - 09:50 PM',
      16: '10:00 PM - 10:50 PM'
    };

    const DAY_MAP = {
      1: 'AHAD', 2: 'ISNIN', 3: 'SELASA', 4: 'RABU',
      5: 'KHAMIS', 6: 'JUMAAT', 7: 'SABTU'
    };

    function formatTime(masa) {
      return TIME_MAP[masa] || `Slot ${masa}`;
    }

    /* ================= RENDER TABLE ================= */
    async function renderTable(rows) {
      const body = $("#resultBody");
      body.empty();

      if (rows.length === 0) {
        body.append(`<tr><td colspan="8" class="w3-center">Tiada pertindihan ruang</td></tr>`);
        return;
      }

      let bil = 1;
      for (const r of rows) {
        const kodSubjek = r.subjek?.kod_subjek || "";
        const seksyen = r.subjek?.seksyen || "";
        const displayCode = r.kod_perkara || kodSubjek;

        let lec = "-";
        if (kodSubjek && seksyen) {
          lec = await getLecturer(kodSubjek, seksyen);
        }

        body.append(`
      <tr class="clash-row">
        <td>${bil++}</td>
        <td>${r.room.kod_ruang}</td>
        <td>${r.room.nama_ruang || "-"}</td>
        <td>${r.room.nama_ruang_singkatan || "-"}</td>
        <td>${r.room.kod_fakulti || "-"}</td>
        <td>${DAY_MAP[r.hari] || r.hari}</td>
        <td>${formatTime(r.masa)}</td>
        <td>${displayCode} - ${seksyen} <br> ${lec}</td>
      </tr>
    `);
      }
    }

    /* ================= LECTURER LOOKUP ================= */
    function getLecturer(kod, seksyen) {
      return new Promise(resolve => {
        const key = `${kod}-${seksyen}`;
        if (state.lecturerCache[key]) {
          resolve(state.lecturerCache[key]);
          return;
        }

        $.ajax({
          url: `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek_pensyarah&kod_subjek=${kod}&sesi=${state.sesi}&semester=${state.semester}&seksyen=${seksyen}`,
          dataType: "json",
          success: d => {
            const name = (d && d.length > 0 && d[0].nama)
              ? d[0].nama
              : "-";
            state.lecturerCache[key] = name;
            resolve(name);
          },
          error: () => {
            state.lecturerCache[key] = "-";
            resolve("-");
          }
        });
      });
    }

    /* ================= ERROR ================= */
    function showError(e) {
      console.error(e);
      $("#resultBody").html(
        `<tr><td colspan="8" class="w3-center w3-red">Ralat memuat data</td></tr>`
      );
    }
  </script>

</body>

</html>