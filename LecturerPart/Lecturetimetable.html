<!DOCTYPE html>
<html>

<head>
    <title>My Lecturer Timetable</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="Styles/MyTimetableStyle.css">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        /* Custom style for slots in the timetable */
        .slot {
            padding: 5px;
            margin: 2px 0;
            border-radius: 4px;
            background-color: #e8f5e9;
            /* Light green background */
            border-left: 5px solid #4caf50;
            /* Green bar */
            font-size: 0.8em;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .w3-table-all th:not(:first-child) {
            text-align: center;
        }

        .info-box {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid #4caf50;
        }
    </style>
</head>

<body class="w3-container">

    <h2 class="w3-center">My Lecturer Timetable</h2>

    <div class="info-box">
        <p><strong>Lecturer:</strong> <span id="lecturerName">Loading...</span></p>
        <p><strong>Staff No:</strong> <span id="staffNo">Loading...</span></p>
        <p><strong>Session/Semester:</strong> <span id="sessionSem">Loading...</span></p>
    </div>

    <div class="loading" id="loadingMsg">
        üîÑ Loading your timetable from TTMS...
    </div>

    <div id="freeTimeChartDiv" style="width: 100%; height: 400px;"></div>
    <hr>

    <table class="w3-table-all" id="timetableTable" style="display:none;">
        <thead>
            <tr>
                <th>Time</th>
                <th>Monday</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
                <th>Friday</th>
            </tr>
        </thead>
        <tbody id="timetableBody"></tbody>
    </table>

    <br>

    <div id="courseListSection" style="display:none;">
        <h3 class="w3-center w3-text-green">üìö My Teaching Courses This Semester</h3>

        <table class="w3-table-all w3-hoverable w3-card-4">
            <thead>
                <tr class="w3-light-grey">
                    <th>No.</th>
                    <th>Course Code</th>
                    <th>Course Name</th>
                    <th>Section</th>
                    <th>Students</th>
                </tr>
            </thead>
            <tbody id="courseListBody"></tbody>
        </table>
    </div>

    <br>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {

            // --- GLOBAL TRACKING FOR FREE TIME ---
            const HOURS_PER_DAY = 10;
            let occupiedSlots = new Set();

            const DAYS_OF_WEEK = {
                2: 'Monday',
                3: 'Tuesday',
                4: 'Wednesday',
                5: 'Thursday',
                6: 'Friday'
            };

            // ==========================================
            // 1. AUTO-GET LECTURER INFO FROM localStorage or Parent
            // ==========================================
            const userSession = window.parent.userSession || JSON.parse(localStorage.getItem("TTMSFC_userSession"));

            let staffNo, fullName, apiStaffNo;

            if (!userSession) {
                // Fallback for testing - GUNA INI UNTUK TEST
                staffNo = '12085'; // Test account login
                apiStaffNo = '23970'; // Test account internal ID (from documentation)
                fullName = 'Test Lecturer';
                $("#lecturerName").text(fullName);
                $("#staffNo").text(staffNo);
            } else {
                staffNo = userSession.login_name; // Display ID (e.g. 12085)
                apiStaffNo = userSession.no_pekerja || userSession.login_name; // Internal ID for API
                fullName = userSession.full_name;
                $("#lecturerName").text(fullName);
                $("#staffNo").text(staffNo);
            }

            console.log("‚úÖ Auto-detected Display Staff No:", staffNo);
            console.log("‚úÖ API Internal Staff No:", apiStaffNo);
            console.log("‚úÖ Lecturer Name:", fullName);

            // ==========================================
            // 2. GET CURRENT SESSION/SEMESTER & START
            // ==========================================
            let currentSesi = window.parent.currentSesi;
            let currentSemester = window.parent.currentSemester;

            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(startExecution);

            function startExecution() {
                if (!currentSesi || !currentSemester) {
                    console.warn("‚ö†Ô∏è Session/Semester not available from parent, fetching...");
                    fetchCurrentSession().then(() => {
                        loadTimetable(apiStaffNo, currentSesi, currentSemester);
                    });
                } else {
                    $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
                    console.log("‚úÖ Using session:", currentSesi, "Semester:", currentSemester);
                    loadTimetable(apiStaffNo, currentSesi, currentSemester);
                }
            }

            // ==========================================
            // FUNCTIONS
            // ==========================================

            function fetchCurrentSession() {
                return fetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester")
                    .then(res => res.json())
                    .then(sessemList => {
                        const active = sessemList.find(s => s.sesi_semester_id) || sessemList[0];
                        currentSesi = active.sesi;
                        currentSemester = active.semester;
                        $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
                        console.log("‚úÖ Fetched session:", currentSesi, currentSemester);
                    })
                    .catch(err => {
                        console.error("‚ùå Error fetching session:", err);
                        $("#sessionSem").text("Error loading session");
                    });
            }

            function loadTimetable(apiStaffNo, sesi, semester) {
                buildEmptyTable();
                fetchLecturerSubjects(apiStaffNo, sesi, semester);
            }

            // ==========================================
            // 3. BUILD EMPTY TIMETABLE GRID
            // ==========================================
            function buildEmptyTable() {
                let body = "";
                // Match MyTimetable.html: 0 to 9 (10 slots)
                for (let hour = 0; hour <= 9; hour++) {
                    body += "<tr>";
                    body += `<td><strong>${formatTime(hour)}</strong></td>`;
                    for (let day = 2; day <= 6; day++) {
                        body += `<td data-day='${day}' data-time='${hour}'></td>`;
                    }
                    body += "</tr>";
                }
                $("#timetableBody").html(body);
                occupiedSlots.clear();
            }

            // ==========================================
            // 4. FETCH LECTURER'S SUBJECTS
            // ==========================================
            function fetchLecturerSubjects(apiStaffNo, sesi, semester) {
                // API endpoint untuk pensyarah subjek
                // Note: param is no_pekerja (internal ID), not login name
                const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pensyarah_subjek&no_pekerja=${apiStaffNo}`;

                console.log("üì° Fetching lecturer subjects from:", url);

                fetch(url)
                    .then(res => res.json())
                    .then(subjects => {
                        console.log("üì¶ All subjects received:", subjects);

                        const currentSubjects = subjects.filter(s =>
                            s.sesi === sesi && s.semester == semester
                        );

                        console.log("‚úÖ Current semester subjects:", currentSubjects);

                        if (currentSubjects.length === 0) {
                            $("#loadingMsg").html("‚ö†Ô∏è No teaching subjects found for current semester.");
                            $("#timetableTable").show();
                            drawFreeTimeChart();
                            return;
                        }

                        displayCourseList(currentSubjects);
                        let promises = currentSubjects.map(subj => fetchSubjectTimetable(subj));

                        Promise.all(promises).then(() => {
                            $("#loadingMsg").hide();
                            $("#timetableTable").show();
                            console.log("‚úÖ Timetable loaded successfully!");
                            drawFreeTimeChart();
                        });
                    })
                    .catch(err => {
                        console.error("‚ùå Error fetching subjects:", err);
                        $("#loadingMsg").html("‚ùå Error loading subjects. Please try again.");
                    });
            }

            // ==========================================
            // 4.5 DISPLAY COURSE LIST
            // ==========================================
            function displayCourseList(courses) {
                $("#courseListBody").empty();

                courses.forEach((course, index) => {
                    const studentCount = course.bil_pelajar || 0;

                    const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${course.kod_subjek}</strong></td>
                    <td>${course.nama_subjek}</td>
                    <td class="w3-center">${course.seksyen}</td>
                    <td class="w3-center"><span class="w3-badge w3-green">${studentCount}</span></td>
                </tr>
            `;
                    $("#courseListBody").append(row);
                });

                $("#courseListSection").show();
            }

            // ==========================================
            // 5. FETCH TIMETABLE PER SUBJECT
            // ==========================================
            function fetchSubjectTimetable(subject) {
                const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${subject.sesi}&semester=${subject.semester}&kod_subjek=${subject.kod_subjek}&seksyen=${subject.seksyen}`;

                console.log(`üì° Fetching timetable for ${subject.kod_subjek}:`, url);

                return fetch(url)
                    .then(res => res.json())
                    .then(times => {
                        console.log(`üìÖ Timetable slots for ${subject.kod_subjek}:`, times);

                        if (Array.isArray(times)) {
                            times.forEach(slot => {
                                placeIntoTable(subject, slot);
                            });
                        }
                    })
                    .catch(err => {
                        console.error(`‚ùå Error fetching timetable for ${subject.kod_subjek}:`, err);
                    });
            }

            // ==========================================
            // 6. PLACE SUBJECT INTO TIMETABLE GRID
            // ==========================================
            function placeIntoTable(subject, slot) {
                const day = slot.hari;
                // Fix: Use slot.masa - 1 directly as the 0-based index. 
                // Previously it was accidentally subtracted twice in some logic comparisons.
                const time = slot.masa - 1;

                console.log(`üìç Placing ${subject.kod_subjek}: Day=${day}, Time=${time}`);

                const slotKey = `${day}-${time}`;
                occupiedSlots.add(slotKey);

                // Fix: Safety check for ruang object
                const room = slot.ruang ? (slot.ruang.nama_ruang_singkatan || slot.ruang.kod_ruang || 'N/A') : 'N/A';

                const cell = $(`td[data-day='${day}'][data-time='${time}']`);

                if (cell.length === 0) {
                    console.warn(`‚ö†Ô∏è Cell not found for Day=${day}, Time=${time}`);
                    return;
                }

                const slotHTML = `
            <div class="slot">
                <strong>${subject.kod_subjek} (${subject.seksyen})</strong><br>
                <small>${subject.nama_subjek}</small><br>
                üìç ${room}
            </div>
        `;

                cell.append(slotHTML);
            }

            // ==========================================
            // 7. TIME FORMATTING
            // ==========================================
            function formatTime(masa) {
                // Fix: Start from 8:00 based on index 0
                const start = 8 + masa;
                const end = start + 1;
                return `${start}:00 - ${end}:00`;
            }

            // ==========================================
            // 8. CHARTING LOGIC
            // ==========================================
            function drawFreeTimeChart() {
                const dailyDataMap = {};
                for (let dayCode = 2; dayCode <= 6; dayCode++) {
                    dailyDataMap[dayCode] = {
                        dayName: DAYS_OF_WEEK[dayCode],
                        occupied: 0,
                        free: HOURS_PER_DAY
                    };
                }

                occupiedSlots.forEach(slotKey => {
                    const dayCode = slotKey.split('-')[0];

                    if (dailyDataMap[dayCode]) {
                        dailyDataMap[dayCode].occupied++;
                        dailyDataMap[dayCode].free--;
                    }
                });

                const dataArray = [
                    ['Day', 'Teaching Time (Hrs)', 'Free Time (Hrs)']
                ];

                for (let dayCode = 2; dayCode <= 6; dayCode++) {
                    const dayEntry = dailyDataMap[dayCode];
                    dataArray.push([
                        dayEntry.dayName,
                        dayEntry.occupied,
                        dayEntry.free
                    ]);
                }

                const data = google.visualization.arrayToDataTable(dataArray);

                const options = {
                    title: 'Weekly Teaching Schedule (8:00 - 18:00)',
                    isStacked: true,
                    legend: { position: 'top', maxLines: 3 },
                    vAxis: {
                        title: 'Hours',
                        minValue: 0,
                        maxValue: HOURS_PER_DAY,
                        ticks: [0, 2, 4, 6, 8, 10]
                    },
                    hAxis: {
                        title: 'Day of Week'
                    },
                    colors: ['#4caf50', '#bdbdbd'], // Green for teaching, Grey for free
                    height: 400
                };

                const chart = new google.visualization.ColumnChart(document.getElementById('freeTimeChartDiv'));
                chart.draw(data, options);
            }
        });
    </script>
</body>

</html>