<!DOCTYPE html>
<html lang="en">

<head>
    <title>TTMS - Lecturer Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="Styles/mainStyle.css">
</head>

<body>

    <header class="app-header">
        <div class="header-left">
            <button id="mobile-menu-btn" class="menu-toggle"><i class="fa fa-bars"></i></button>
            <img src="Logo/UTM-LOGO.png" alt="UTM Logo" class="nav-logo">
            <span class="brand-text">TTMS <span class="brand-sub">Lecturer</span></span>
        </div>
        <div class="header-right">
            <div class="user-pill">
                <span class="welcome-msg">Hi, <strong id="user">Lecturer</strong></span>
                <div class="divider"></div>
                <button id="logout" class="btn-logout">Logout</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebarMenu">
            <nav class="nav-container">
                <div class="nav-group">
                    <a href="#" class="nav-link active" id="announcement-dashboard">
                        <i class="fa fa-bullhorn"></i> Announcements
                    </a>
                </div>

                <div class="nav-group">
                    <div class="nav-label">Timetable</div>
                    <a href="#" class="nav-link" id="my-timetable"><i class="fa fa-calendar"></i> My Timetable</a>
                    <a href="#" class="nav-link" id="timetable-analyzer"><i class="fa fa-search"></i> Timetable
                        Analyzer</a>
                    <a href="#" class="nav-link" id="course-list"><i class="fa fa-list-alt"></i> My CourseList</a>
                    <a href="#" class="nav-link" id="room-availability"><i class="fa fa-building"></i> Room
                        Availability</a>
                </div>

                <div class="nav-group">
                    <div class="nav-label">Analysis</div>
                    <a href="#" class="nav-link" id="room-usage"><i class="fa fa-line-chart"></i> Room Usage</a>
                    <a href="#" class="nav-link" id="room-clash-analyzer"><i class="fa fa-exclamation-triangle"></i>
                        Room Clash Analyzer</a>
                </div>
            </nav>
        </aside>

        <div id="sidebar-overlay" class="overlay"></div>

        <main id="mainContent" class="content-area">
            <div class="loader-container" style="text-align: center; margin-top: 50px;">
                <i class="fa fa-spinner fa-spin" style="font-size: 2em; color: var(--primary-mint);"></i>
                <h2 style="color: var(--text-muted);">Initializing System...</h2>
            </div>
        </main>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>

        const BASE_URL = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=";
        const AUTH_URL = "http://web.fc.utm.my/ttms/auth-admin.php?session_id=";

        window.userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));
        window.currentSesi = null;
        window.currentSemester = null;

        if (!window.userSession) window.location.replace("Login.html");

        // Helper to update UI inside loaded pages if needed
        function updateSessionUI() {
            // Can be used by child pages if they have specific UI to update
        }

        function handleMenuClick(targetId, url) {
            $('.nav-link').removeClass('active');
            $(`#${targetId}`).addClass('active');

            $('#mainContent').load(url, function (response, status, xhr) {
                if (status == "error") {
                    $('#mainContent').html(`<div style="padding:20px; color:red;">Error loading page: ${xhr.status} ${xhr.statusText}</div>`);
                }

                updateSessionUI();

                if ($(window).width() <= 992) {
                    $('#sidebarMenu').removeClass('open');
                    $('#sidebar-overlay').fadeOut();
                }
            });
        }

        function initDashboard() {
            // 1. Fetch Admin Session (Required for some APIs)
            fetch(AUTH_URL + window.userSession.session_id)
                .then(res => res.json())
                .then(data => {
                    window.adminSessionID = (data && data[0]) ? data[0].session_id : null;
                    console.log("Admin Session ID:", window.adminSessionID);

                    // 2. Fetch Semester Info
                    return fetch(BASE_URL + "sesisemester").then(res => res.json());
                })
                .then(sesiData => {
                    const active = Array.isArray(sesiData) ? sesiData.find(s => s.sesi_semester_id) : sesiData;
                    if (active) {
                        window.currentSesi = active.sesi;
                        window.currentSemester = active.semester;
                    }
                    // Load default page
                    handleMenuClick('announcement-dashboard', 'Announcement.html');
                })
                .catch(err => {
                    console.error("Initialization Error:", err);
                    // Try to load announcement anyway
                    handleMenuClick('announcement-dashboard', 'Announcement.html');
                });
        }

        $(document).ready(function () {
            const fullName = window.userSession.full_name || 'Lecturer';
            $('#user').text(fullName); // Show full name or simplified

            initDashboard();

            $('#mobile-menu-btn').click(() => {
                $('#sidebarMenu').toggleClass('open');
                $('#sidebar-overlay').fadeToggle();
            });

            $('#logout').click(() => {
                localStorage.removeItem("TTMSFC_userSession");
                window.location.replace("Login.html");
            });

            // Menu Listeners
            $('#announcement-dashboard').click((e) => { e.preventDefault(); handleMenuClick('announcement-dashboard', 'Announcement.html'); });

            // Timetable
            $('#my-timetable').click((e) => { e.preventDefault(); handleMenuClick('my-timetable', 'LecturerPart/Lecturetimetable.html'); });
            $('#timetable-analyzer').click((e) => { e.preventDefault(); handleMenuClick('timetable-analyzer', 'LecturerPart/timetableClashLect.html'); });
            $('#course-list').click((e) => { e.preventDefault(); handleMenuClick('course-list', 'LecturerPart/LectureCourseList.html'); });
            $('#room-availability').click((e) => { e.preventDefault(); handleMenuClick('room-availability', 'LecturerPart/RoomsAvailability.html'); });

            // Analysis
            $('#room-usage').click((e) => { e.preventDefault(); handleMenuClick('room-usage', 'LecturerPart/RoomUsage.html'); });
            $('#room-clash-analyzer').click((e) => { e.preventDefault(); handleMenuClick('room-clash-analyzer', 'LecturerPart/RoomClashAnalyzer.html'); });
        });
      
        // --- GLOBAL VARIABLES & CONSTANTS ---
        const BASE_URL = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=";
        const AUTH_URL = "http://web.fc.utm.my/ttms/auth-admin.php?session_id=";

        // Global variables must be window-scoped to be accessible by content pages (e.g., MyTimetable.html)
        window.userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));
        window.adminSessionID = null;
        window.currentSesi = null;
        window.currentSemester = null;

        // --- SESSION GUARD & INITIALIZATION ---

        if (!userSession) {
            // Redirect to login if user session is not found
            window.location.replace("Login.html");
        }

        // Display user name
        $('#user').text(userSession.full_name || 'Admin');

        // Start Initialization Sequence
        initDashboard();

        /**
         * Executes sequential AJAX calls to fetch critical context data.
         * This uses a Promise chain to ensure variables are set before loading the default page.
         */
        function initDashboard() {
            // 1. Get Admin Session ID
            getAdminSession(userSession.session_id)
                .then(adminData => {
                    window.adminSessionID = adminData.session_id;
                    console.log("Admin Session ID obtained.");
                    // 2. Get the current active session-semester
                    return getCurrentSessionSemester();
                })
                .then(sesiData => {
                    // Find the active session object
                    const activeSession = Array.isArray(sesiData) ? sesiData.find(s => s.sesi_semester_id) : sesiData;

                    if (activeSession) {
                        window.currentSesi = activeSession.sesi;
                        window.currentSemester = activeSession.semester;
                        console.log(`Current Sesi: ${window.currentSesi}, Semester: ${window.currentSemester}`);
                    } else {
                        throw new Error("Could not determine current active session/semester.");
                    }

                    // *** DEFAULT VIEW: LOAD ANNOUNCEMENT.HTML ***
                    // This executes ONLY after all context variables are set.
                    $('#mainContent').load('Announcement.html');

                })
                .catch(error => {
                    console.error("Initialization failed:", error);
                    // Display error message if critical data fails to load
                    $('#mainContent').html('<div class="w3-panel w3-red w3-margin-top"><p><strong>System Error:</strong> Failed to initialize critical context. Please check network and API access.</p></div>');
                });
        }

        // --- TTMS WEB SERVICE FETCHERS ---

        function getAdminSession(userSessionID) {
            // auth-admin.php endpoint
            return fetch(AUTH_URL + userSessionID)
                .then(res => res.json())
                .then(data => data[0] || Promise.reject("Invalid Admin Session response"));
        }

        function getCurrentSessionSemester() {
            // sesisemester entity
            return fetch(BASE_URL + "sesisemester")
                .then(res => res.json());
        }

        // --- NAVIGATION LOGIC ---

        // Function to handle content loading
        function loadContent(url) {
            $('#mainContent').load(url);
        }

        // Logout Function 
        $('#logout').click(function () {
            localStorage.removeItem("TTMSFC_userSession");
            localStorage.removeItem("TTMSFC_sessionList");
            window.location.replace("Login.html");
        });

        // --- MENU HANDLERS ---
        // Change the default active highlight when clicking a menu item
        function handleMenuClick(targetId, url) {
            $('.w3-bar-item.w3-blue-dark').removeClass('w3-blue-dark');

            let target = $(`#${targetId}`);
            if (!target.is('a')) {
                // If it's a submenu link, highlight the parent button
                target = $(`#${targetId}`).closest('.w3-dropdown-content').prev('button');
            }
            target.addClass('w3-blue-dark');
            loadContent(url);
        }

        // Default Page
        $('#announcement-dashboard').click(() => handleMenuClick('announcement-dashboard', '../Announcement.html'));

        // TIMETABLE Category
        $('#my-timetable').click(() => handleMenuClick('my-timetable', 'LecturerPart/Lecturetimetable.html'));
        $('#timetable-analyzer').click(() => handleMenuClick('timetable-analyzer', 'LecturerPart/timetableClashLect.html'));
        $('#course-list').click(() => handleMenuClick('course-list', 'LecturerPart/LectureCourseList.html'));
        $('#room-availability').click(() => handleMenuClick('room-availability', 'LecturerPart/RoomsAvailability.html'));

        // ANALYSIS Category
        $('#room-usage').click(() => handleMenuClick('room-usage', 'LecturerPart/RoomUsage.html'));
        $('#room-clash-analyzer').click(() => handleMenuClick('room-clash-analyzer', 'LecturerPart/RoomClashAnalyzer.html'));
        // $('#lecture-time').click(() => handleMenuClick('lecture-time', 'LecturerPart/LectAndTime.html'));
      
    </script>
</body>

</html>