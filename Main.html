<!DOCTYPE html>
<html>
<head>
    <title>TTMS - Visualization Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="Styles/mainStyle.css"> 
</head>
<body>

<div class="utm-header">
    <div class="header-title">
        TTMS - Visualization Support System
    </div>
    <div class="user-links">
        <span class="w3-large w3-hide-small">Welcome, <span id="user">???</span> |</span>
        <a href="#" id="logout">Logout</a> 
    </div>
</div>

<nav class="w3-sidebar w3-bar-block w3-light-grey">
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="announcement-dashboard">ğŸ“¢ Announcements</a>
    
    <h5 class="w3-bar-item w3-text-gray w3-border-bottom"><b>TIMETABLE</b></h5>
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="my-timetable">ğŸ“… My Timetable</a>
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="room-availability">ğŸ« Room Availability</a>
    <hr>
    <h5 class="w3-bar-item w3-text-gray w3-border-bottom"><b>ANALYSIS</b></h5>
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="clash-analyzer">ğŸ” Timetable Clash Analyzer</a>
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="room-usage">ğŸ“ˆ Room Usage</a>
    <a href="#" class="w3-bar-item w3-button w3-hover-light-grey" id="course-list">ğŸ“š Courses</a>
</nav>

<div id="mainContent">
    <div class="w3-container w3-center" style="margin-top:100px;">
        <i class="fa fa-spinner fa-spin" style="font-size:64px"></i>
        <h2>System Loading...</h2>
        <p>Initializing TTMS session and fetching current semester context. Please wait...</p>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    // --- GLOBAL VARIABLES ---
    const BASE_URL = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=";
    const AUTH_URL = "http://web.fc.utm.my/ttms/auth-admin.php?session_id=";
    
    window.userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));
    window.adminSessionID = null;
    window.currentSesi = null;
    window.currentSemester = null;

    // --- SESSION GUARD ---
    if (!userSession) {
        window.location.replace("Login.html");
    }

    $(document).ready(function() {
        $('#user').text(userSession.full_name || 'User');
        initDashboard();
    });

    /**
     * HANDSHAKE LOGIC:
     * We wait for Admin Session AND Semester data before loading the first page.
     */
    function initDashboard() {
        getAdminSession(userSession.session_id)
            .then(adminData => {
                window.adminSessionID = adminData.session_id;
                return getCurrentSessionSemester();
            })
            .then(sesiData => {
                const activeSession = Array.isArray(sesiData) ? sesiData.find(s => s.sesi_semester_id) : sesiData;

                if (activeSession) {
                    window.currentSesi = activeSession.sesi;
                    window.currentSemester = activeSession.semester;
                }

                // SUCCESS: Load the default page and highlight the menu
                handleMenuClick('announcement-dashboard', 'StudentPart/Announcement.html');
            })
            .catch(error => {
                console.error("Initialization failed:", error);
                $('#mainContent').html('<div class="w3-panel w3-red"><h3>Error</h3><p>Failed to connect to TTMS API.</p></div>');
            });
    }

    // --- API FETCHERS ---
    function getAdminSession(userSessionID) {
        return fetch(AUTH_URL + userSessionID).then(res => res.json()).then(data => data[0]);
    }

    function getCurrentSessionSemester() {
        return fetch(BASE_URL + "sesisemester").then(res => res.json()); 
    }
    
    // --- NAVIGATION LOGIC ---
    function handleMenuClick(targetId, url) {
        // Remove active color from all buttons
        $('.w3-bar-item').removeClass('w3-blue'); 
        // Add active color to clicked button
        $(`#${targetId}`).addClass('w3-blue');
        
        // AJAX Load content
        $('#mainContent').load(url, function(response, status, xhr) { //this loadContent function
            if (status == "error") {
                $("#mainContent").html(`<div class="w3-padding"><h3>File Not Found</h3><p>Could not load: ${url}</p></div>`);
            }
        });
    }

    // Logout Function 
    $('#logout').click(function() {
        localStorage.removeItem("TTMSFC_userSession");
        window.location.replace("Login.html");
    });
    
    // --- MENU EVENT LISTENERS ---
    $('#announcement-dashboard').click(() => handleMenuClick('announcement-dashboard', 'StudentPart/Announcement.html'));
    $('#my-timetable').click(() => handleMenuClick('my-timetable', 'StudentPart/Timetable/MyTimetable.html'));
    $('#room-availability').click(() => handleMenuClick('room-availability', 'StudentPart/RoomAvailability/RoomAvailability.html'));
    $('#clash-analyzer').click(() => handleMenuClick('clash-analyzer', 'StudentPart/TimetableClash/TimetableClashAnalyzer.html')); 
    $('#room-usage').click(() => handleMenuClick('room-usage', 'StudentPart/RoomUsage/RoomUsage.html'));
    $('#course-list').click(() => handleMenuClick('course-list', 'StudentPart/CourseList.html')); 

</script>
</body>
</html>