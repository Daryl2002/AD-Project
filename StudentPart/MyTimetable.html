<!DOCTYPE html>
<html>
<head>
    <title>My Timetable</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
        }
        th {
            background: #f44336;
            color: white;
        }
        .slot {
            background: #bbdefb;
            border-radius: 4px;
            padding: 5px;
            margin: 2px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>

<body class="w3-container">

<h2 class="w3-center">My Timetable</h2>

<!-- Display User Info -->
<div class="info-box">
    <p><strong>Student:</strong> <span id="studentName">Loading...</span></p>
    <p><strong>Matric No:</strong> <span id="matricNo">Loading...</span></p>
    <p><strong>Session/Semester:</strong> <span id="sessionSem">Loading...</span></p>
</div>

<div class="loading" id="loadingMsg">
    üîÑ Loading your timetable from TTMS...
</div>

<table class="w3-table-all" id="timetableTable" style="display:none;">
    <thead>
        <tr>
            <th>Time</th>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
        </tr>
    </thead>
    <tbody id="timetableBody"></tbody>
</table>

<br>

<!-- Course List Section -->
<div id="courseListSection" style="display:none;">
    <h3 class="w3-center w3-text-blue">üìö My Courses This Semester</h3>
    
    <table class="w3-table-all w3-hoverable w3-card-4">
        <thead>
            <tr class="w3-light-grey">
                <th>No.</th>
                <th>Course Code</th>
                <th>Course Name</th>
                <th>Section</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="courseListBody"></tbody>
    </table>
</div>

<br>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
$(document).ready(function() {

    // ==========================================
    // 1. AUTO-GET MATRIC FROM localStorage
    // ==========================================
    const userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));
    
    if (!userSession) {
        alert("Session not found! Please login again.");
        window.location.href = "../Login.html";
        return;
    }

    const matric = userSession.login_name;  // Matric number
    const fullName = userSession.full_name; // Student name

    // Display user info
    $("#studentName").text(fullName);
    $("#matricNo").text(matric);

    console.log("‚úÖ Auto-detected Matric:", matric);
    console.log("‚úÖ Student Name:", fullName);

    // ==========================================
    // 2. GET CURRENT SESSION/SEMESTER (from Main.html global vars)
    // ==========================================
    let currentSesi = window.parent.currentSesi;
    let currentSemester = window.parent.currentSemester;

    // Fallback: if not loaded yet, fetch from API
    if (!currentSesi || !currentSemester) {
        console.warn("‚ö†Ô∏è Session/Semester not available from parent, fetching...");
        fetchCurrentSession().then(() => {
            loadTimetable(matric, currentSesi, currentSemester);
        });
    } else {
        $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
        console.log("‚úÖ Using session:", currentSesi, "Semester:", currentSemester);
        loadTimetable(matric, currentSesi, currentSemester);
    }

    // ==========================================
    // FUNCTIONS
    // ==========================================

    function fetchCurrentSession() {
        return fetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester")
            .then(res => res.json())
            .then(sessemList => {
                const active = sessemList.find(s => s.sesi_semester_id) || sessemList[0];
                currentSesi = active.sesi;
                currentSemester = active.semester;
                $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
                console.log("‚úÖ Fetched session:", currentSesi, currentSemester);
            })
            .catch(err => {
                console.error("‚ùå Error fetching session:", err);
                $("#sessionSem").text("Error loading session");
            });
    }

    function loadTimetable(matric, sesi, semester) {
        // Build empty timetable grid
        buildEmptyTable();

        // Fetch student's subjects
        fetchStudentSubjects(matric, sesi, semester);
    }

    // ==========================================
    // 3. BUILD EMPTY TIMETABLE GRID
    // ==========================================
    function buildEmptyTable() {
        let body = "";
        for (let hour = 1; hour <= 10; hour++) {  
            body += "<tr>";
            body += `<td><strong>${formatTime(hour)}</strong></td>`;
            body += `<td data-day='2' data-time='${hour}'></td>`;
            body += `<td data-day='3' data-time='${hour}'></td>`;
            body += `<td data-day='4' data-time='${hour}'></td>`;
            body += `<td data-day='5' data-time='${hour}'></td>`;
            body += `<td data-day='6' data-time='${hour}'></td>`;
            body += "</tr>";
        }
        $("#timetableBody").html(body);
    }

    // ==========================================
    // 4. FETCH STUDENT'S SUBJECTS
    // ==========================================
    function fetchStudentSubjects(matric, sesi, semester) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${matric}`;

        fetch(url)
            .then(res => res.json())
            .then(subjects => {
                // Filter current semester only
                const currentSubjects = subjects.filter(s => 
                    s.sesi === sesi && s.semester == semester
                );

                console.log(`üìö Found ${currentSubjects.length} subjects for this semester`);

                if (currentSubjects.length === 0) {
                    $("#loadingMsg").html("‚ö†Ô∏è No subjects found for current semester.");
                    return;
                }

                // Display course list
                displayCourseList(currentSubjects);

                // Fetch timetable for each subject
                let promises = currentSubjects.map(subj => fetchSubjectTimetable(subj));

                Promise.all(promises).then(() => {
                    $("#loadingMsg").hide();
                    $("#timetableTable").show();
                    console.log("‚úÖ Timetable loaded successfully!");
                });
            })
            .catch(err => {
                console.error("‚ùå Error fetching subjects:", err);
                $("#loadingMsg").html("‚ùå Error loading subjects. Please try again.");
            });
    }

    // ==========================================
    // 4.5 DISPLAY COURSE LIST
    // ==========================================
    function displayCourseList(courses) {
        $("#courseListBody").empty();
        
        courses.forEach((course, index) => {
            // Determine status badge color
            let statusBadge = '';
            if (course.status === 'UM') {
                statusBadge = '<span class="w3-tag w3-green">UM</span>';
            } else if (course.status === '-') {
                statusBadge = '<span class="w3-tag w3-blue">Active</span>';
            } else {
                statusBadge = `<span class="w3-tag w3-grey">${course.status}</span>`;
            }

            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${course.kod_subjek}</strong></td>
                    <td>${course.nama_subjek}</td>
                    <td class="w3-center">${course.seksyen}</td>
                    <td class="w3-center">${statusBadge}</td>
                </tr>
            `;
            $("#courseListBody").append(row);
        });

        $("#courseListSection").show();
        console.log("‚úÖ Course list displayed");
    }

    // ==========================================
    // 5. FETCH TIMETABLE PER SUBJECT
    // ==========================================
    function fetchSubjectTimetable(subject) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${subject.sesi}&semester=${subject.semester}&kod_subjek=${subject.kod_subjek}&seksyen=${subject.seksyen}`;

        return fetch(url)
            .then(res => res.json())
            .then(times => {
                times.forEach(slot => {
                    placeIntoTable(subject, slot);
                });
            })
            .catch(err => {
                console.error(`‚ùå Error fetching timetable for ${subject.kod_subjek}:`, err);
            });
    }

    // ==========================================
    // 6. PLACE SUBJECT INTO TIMETABLE GRID
    // ==========================================
    function placeIntoTable(subject, slot) {
        const day = slot.hari;      // 2 = Monday
        const time = slot.masa;     // 4 = 10am
        const room = slot.ruang.nama_ruang_singkatan || slot.ruang.kod_ruang;

        const cell = $(`td[data-day='${day}'][data-time='${time}']`);

        // Check if cell already has content (handle multiple classes same time)
        let existingContent = cell.html();
        
        const slotHTML = `
            <div class="slot">
                <strong>${subject.kod_subjek}</strong><br>
                <small>${subject.nama_subjek}</small><br>
                üìç ${room}
            </div>
        `;

        cell.append(slotHTML);
    }

    // ==========================================
    // 7. TIME FORMATTING
    // ==========================================
    function formatTime(masa) {
        const start = 7 + masa; // masa=1 ‚Üí 8am
        const end = start + 1;
        return `${start}:00 - ${end}:00`;
    }

});
</script>
</body>
</html>