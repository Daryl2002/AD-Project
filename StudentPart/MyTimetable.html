<!DOCTYPE html>
<html>
<head>
    <title>My Timetable</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="Styles/MyTimetableStyle.css"> 
    <script src="../Authenticate.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        /* Custom style for slots in the timetable */
        .slot {
            padding: 5px;
            margin: 2px 0;
            border-radius: 4px;
            background-color: #e0f7fa; /* Light cyan background */
            border-left: 5px solid #00bcd4; /* Cyan bar */
            font-size: 0.8em;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .w3-table-all th:not(:first-child) {
             text-align: center;
        }
    </style>
</head>

<body class="w3-container">

<h2 class="w3-center">My Timetable</h2>

<div class="info-box">
    <p><strong>Student:</strong> <span id="studentName">Loading...</span></p>
    <p><strong>Matric No:</strong> <span id="matricNo">Loading...</span></p>
    <p><strong>Session/Semester:</strong> <span id="sessionSem">Loading...</span></p>
</div>

<div class="loading" id="loadingMsg">
    üîÑ Loading your timetable from TTMS...
</div>

<div id="freeTimeChartDiv" style="width: 100%; height: 400px;"></div>
<hr>

<table class="w3-table-all" id="timetableTable" style="display:none;">
    <thead>
        <tr>
            <th>Time</th>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
        </tr>
    </thead>
    <tbody id="timetableBody"></tbody>
</table>

<br>

<div id="courseListSection" style="display:none;">
    <h3 class="w3-center w3-text-blue">üìö My Courses This Semester</h3>
    
    <table class="w3-table-all w3-hoverable w3-card-4">
        <thead>
            <tr class="w3-light-grey">
                <th>No.</th>
                <th>Course Code</th>
                <th>Course Name</th>
                <th>Section</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="courseListBody"></tbody>
    </table>
</div>

<br>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
$(document).ready(function() {

    // --- GLOBAL TRACKING FOR FREE TIME ---
    // Total possible slots per day: 10 hours (8:00 to 18:00)
    const HOURS_PER_DAY = 10;
    // Set stores unique occupied slots using key: 'Day-Time' (e.g., '2-4' for Mon, 10am)
    let occupiedSlots = new Set();
    
    // Day code mapping (API uses 2 for Monday, 6 for Friday)
    const DAYS_OF_WEEK = {
        2: 'Monday',
        3: 'Tuesday',
        4: 'Wednesday',
        5: 'Thursday',
        6: 'Friday'
    };

    // ==========================================
    // 1. AUTO-GET MATRIC FROM localStorage
    // ==========================================
    const userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));
    
    if (!userSession) {
        // Fallback for testing when localStorage is not available
        const matric = ''; 
        const fullName = '';
        $("#studentName").text(fullName);
        $("#matricNo").text(matric);
        
    } else {
        const matric = userSession.login_name;  
        const fullName = userSession.full_name;
        $("#studentName").text(fullName);
        $("#matricNo").text(matric);
    }
    
    const matric = $("#matricNo").text();
    const fullName = $("#studentName").text();

    console.log("‚úÖ Auto-detected Matric:", matric);
    console.log("‚úÖ Student Name:", fullName);


    // ==========================================
    // 2. GET CURRENT SESSION/SEMESTER & START EXECUTION
    // ==========================================
    let currentSesi = window.parent.currentSesi;
    let currentSemester = window.parent.currentSemester;
    
    // FIX: Load the chart package and wrap the entire execution inside the callback.
    // This resolves the "Must call google.charts.load" error.
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(startExecution);
    
    function startExecution() {
        if (!currentSesi || !currentSemester) {
            console.warn("‚ö†Ô∏è Session/Semester not available from parent, fetching...");
            fetchCurrentSession().then(() => {
                loadTimetable(matric, currentSesi, currentSemester);
            });
        } else {
            $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
            console.log("‚úÖ Using session:", currentSesi, "Semester:", currentSemester);
            loadTimetable(matric, currentSesi, currentSemester);
        }
    }

    // ==========================================
    // FUNCTIONS
    // ==========================================

    function fetchCurrentSession() {
        return fetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester")
            .then(res => res.json())
            .then(sessemList => {
                const active = sessemList.find(s => s.sesi_semester_id) || sessemList[0];
                currentSesi = active.sesi;
                currentSemester = active.semester;
                $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
                console.log("‚úÖ Fetched session:", currentSesi, currentSemester);
            })
            .catch(err => {
                console.error("‚ùå Error fetching session:", err);
                $("#sessionSem").text("Error loading session");
            });
    }

    function loadTimetable(matric, sesi, semester) {
        buildEmptyTable();
        fetchStudentSubjects(matric, sesi, semester);
    }

    // ==========================================
    // 3. BUILD EMPTY TIMETABLE GRID
    // ==========================================
    function buildEmptyTable() {
        let body = "";
        for (let hour = 0; hour <= 9; hour++) {  
            body += "<tr>";
            body += `<td><strong>${formatTime(hour)}</strong></td>`;
            // Day codes 2 (Mon) to 6 (Fri)
            for (let day = 2; day <= 6; day++) {
                body += `<td data-day='${day}' data-time='${hour}'></td>`;
            }
            body += "</tr>";
        }
        $("#timetableBody").html(body);
        
        // Clear previous tracking for fresh calculation
        occupiedSlots.clear();
    }

    // ==========================================
    // 4. FETCH STUDENT'S SUBJECTS
    // ==========================================
    function fetchStudentSubjects(matric, sesi, semester) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${matric}`;

        fetch(url)
            .then(res => res.json())
            .then(subjects => {
                const currentSubjects = subjects.filter(s => 
                    s.sesi === sesi && s.semester == semester
                );

                if (currentSubjects.length === 0) {
                    $("#loadingMsg").html("‚ö†Ô∏è No subjects found for current semester.");
                    // Draw empty chart if no subjects
                    drawFreeTimeChart(); 
                    return;
                }

                displayCourseList(currentSubjects);
                let promises = currentSubjects.map(subj => fetchSubjectTimetable(subj));

                Promise.all(promises).then(() => {
                    $("#loadingMsg").hide();
                    $("#timetableTable").show();
                    console.log("‚úÖ Timetable loaded successfully!");
                    
                    // Draw the free time chart after everything is placed
                    drawFreeTimeChart(); 
                });
            })
            .catch(err => {
                console.error("‚ùå Error fetching subjects:", err);
                $("#loadingMsg").html("‚ùå Error loading subjects. Please try again.");
            });
    }

    // ==========================================
    // 4.5 DISPLAY COURSE LIST
    // ==========================================
    function displayCourseList(courses) {
        $("#courseListBody").empty();
        
        courses.forEach((course, index) => {
            let statusBadge = '';
            if (course.status === 'UM') {
                statusBadge = '<span class="w3-tag w3-green">UM</span>';
            } else if (course.status === '-') {
                statusBadge = '<span class="w3-tag w3-blue">Active</span>';
            } else {
                statusBadge = `<span class="w3-tag w3-grey">${course.status}</span>`;
            }

            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${course.kod_subjek}</strong></td>
                    <td>${course.nama_subjek}</td>
                    <td class="w3-center">${course.seksyen}</td>
                    <td class="w3-center">${statusBadge}</td>
                </tr>
            `;
            $("#courseListBody").append(row);
        });

        $("#courseListSection").show();
    }

    // ==========================================
    // 5. FETCH TIMETABLE PER SUBJECT
    // ==========================================
    function fetchSubjectTimetable(subject) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${subject.sesi}&semester=${subject.semester}&kod_subjek=${subject.kod_subjek}&seksyen=${subject.seksyen}`;

        return fetch(url)
            .then(res => res.json())
            .then(times => {
                if (Array.isArray(times)) {
                    times.forEach(slot => {
                        placeIntoTable(subject, slot);
                    });
                } 
            })
            .catch(err => {
                console.error(`‚ùå Error fetching timetable for ${subject.kod_subjek}:`, err);
            });
    }

    // ==========================================
    // 6. PLACE SUBJECT INTO TIMETABLE GRID
    // ==========================================
    function placeIntoTable(subject, slot) {
        const day = slot.hari;           
        const time = slot.masa -1;     
        
        // Track occupied slots using the day-time key
        const slotKey = `${day}-${time-1}`;
        occupiedSlots.add(slotKey);

        const room = slot.ruang.nama_ruang_singkatan || slot.ruang.kod_ruang || 'N/A';

        const cell = $(`td[data-day='${day}'][data-time='${time-1}']`);

        const slotHTML = `
            <div class="slot">
                <strong>${subject.kod_subjek} (${subject.seksyen})</strong><br>
                <small>${subject.nama_subjek}</small><br>
                üìç ${room}
            </div>
        `;

        cell.append(slotHTML);
    }

    // ==========================================
    // 7. TIME FORMATTING
    // ==========================================
    function formatTime(masa) {
        const start = 8 + masa; 
        const end = start + 1;
        return `${start}:00 - ${end}:00`;
    }

    // ==========================================
    // 8. CHARTING LOGIC (STACKED COLUMN CHART BY DAY)
    // ==========================================
    function drawFreeTimeChart() {
        // 1. Initialize data structure for 5 days
        const dailyDataMap = {};
        for (let dayCode = 2; dayCode <= 6; dayCode++) {
            dailyDataMap[dayCode] = {
                dayName: DAYS_OF_WEEK[dayCode],
                occupied: 0,
                free: HOURS_PER_DAY
            };
        }

        // 2. Count occupied hours per day
        occupiedSlots.forEach(slotKey => {
            // slotKey is 'DayCode-Time' (e.g., '2-4')
            const dayCode = slotKey.split('-')[0];
            
            if (dailyDataMap[dayCode]) {
                dailyDataMap[dayCode].occupied++;
                dailyDataMap[dayCode].free--;
            }
        });
        
        // 3. Prepare Google Chart DataTable
        const dataArray = [
          ['Day', 'Occupied Time (Hrs)', 'Free Time (Hrs)']
        ];

        // Convert the map data into the array format required by Google Charts
        for (let dayCode = 2; dayCode <= 6; dayCode++) {
            const dayEntry = dailyDataMap[dayCode];
            dataArray.push([
                dayEntry.dayName,
                dayEntry.occupied,
                dayEntry.free
            ]);
        }

        const data = google.visualization.arrayToDataTable(dataArray);

        // 4. Define Chart Options
        const options = {
          title: 'Daily Time Allocation (8:00 - 18:00)',
          isStacked: true, // Crucial for Stacked Column Chart
          legend: { position: 'top', maxLines: 3 },
          vAxis: {
            title: 'Hours',
            minValue: 0,
            maxValue: HOURS_PER_DAY,
            ticks: [0, 2, 4, 6, 8, 10]
          },
          hAxis: {
            title: 'Day of Week'
          },
          colors: ['#00bcd4', '#bdbdbd'], // Cyan for occupied, Grey for free
          height: 400
        };

        // 5. Draw the Chart
        const chart = new google.visualization.ColumnChart(document.getElementById('freeTimeChartDiv'));
        chart.draw(data, options);
    }
});
</script>
</body>
</html>