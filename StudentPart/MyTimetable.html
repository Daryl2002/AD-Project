<html lang="en">
<head>
    <title>TTMS - My Timetable</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="Styles/MyTimetableStyle.css">
</head>
<body>

<div class="timetable-wrapper">
    <div class="timetable-header">
        <h2>My Timetable</h2>
        <div class="info-grid">
            <div class="info-stat-card">
                <label>Student</label>
                <span id="studentName">Loading...</span>
            </div>
            <div class="info-stat-card">
                <label>ID No.</label>
                <span id="matricNo">Loading...</span>
            </div>
            <div class="info-stat-card">
                <label>Current Term</label>
                <span id="sessionSem">Loading...</span>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div id="freeTimeChartDiv"></div>
    </div>

    <div class="loading" id="loadingMsg">
        <i class="fa fa-spinner fa-spin"></i> Synchronizing with TTMS...
    </div>

    <div class="table-container" id="timetableContainer" style="display:none;">
        <table class="proto-table">
            <thead>
                <tr>
                    <th class="time-header">Time</th>
                    <th>MON</th>
                    <th>TUE</th>
                    <th>WED</th>
                    <th>THU</th>
                    <th>FRI</th>
                </tr>
            </thead>
            <tbody id="timetableBody"></tbody>
        </table>
    </div>

    <div class="course-section" id="courseListSection" style="display:none;">
        <h3>Registered Courses</h3>
        <div class="table-container">
            <table class="course-table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Course Name</th>
                        <th class="center">Section</th>
                        <th class="center">Status</th>
                    </tr>
                </thead>
                <tbody id="courseListBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const HOURS_PER_DAY = 10;
    let occupiedSlots = new Set();
    const DAYS_OF_WEEK = { 2: 'Monday', 3: 'Tuesday', 4: 'Wednesday', 5: 'Thursday', 6: 'Friday' };

    // Get Session Data
    const userSession = window.parent.userSession || JSON.parse(localStorage.getItem("TTMSFC_userSession"));
    const currentSesi = window.parent.currentSesi;
    const currentSemester = window.parent.currentSemester;

    if (userSession) {
        $("#studentName").text(userSession.full_name);
        $("#matricNo").text(userSession.login_name);
    }

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(startExecution);

    function startExecution() {
        if (currentSesi && currentSemester) {
            $("#sessionSem").text(`Sesi ${currentSesi} (Sem ${currentSemester})`);
            buildEmptyTable();
            fetchStudentSubjects(userSession.login_name, currentSesi, currentSemester);
        }
    }

    function buildEmptyTable() {
        let body = "";
        for (let hour = 0; hour <= 9; hour++) {  
            body += `<tr><td class="time-cell">${formatTime(hour)}</td>`;
            for (let day = 2; day <= 6; day++) {
                body += `<td data-day='${day}' data-time='${hour}'></td>`;
            }
            body += "</tr>";
        }
        $("#timetableBody").html(body);
    }

    function fetchStudentSubjects(matric, sesi, semester) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${matric}`;
        fetch(url).then(res => res.json()).then(subjects => {
            const current = subjects.filter(s => s.sesi === sesi && s.semester == semester);
            displayCourseList(current);
            let promises = current.map(subj => fetchSubjectTimetable(subj));
            Promise.all(promises).then(() => {
                $("#loadingMsg").hide();
                $("#timetableContainer").show();
                drawFreeTimeChart();
            });
        });
    }

    function fetchSubjectTimetable(subject) {
        const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${subject.sesi}&semester=${subject.semester}&kod_subjek=${subject.kod_subjek}&seksyen=${subject.seksyen}`;
        return fetch(url).then(res => res.json()).then(times => {
            if (Array.isArray(times)) {
                times.forEach(slot => {
                    const day = slot.hari;
                    const timeIdx = slot.masa - 1;
                    occupiedSlots.add(`${day}-${timeIdx}`);
                    const room = slot.ruang.nama_ruang_singkatan || 'N/A';
                    $(`td[data-day='${day}'][data-time='${timeIdx}']`).append(`
                        <div class="slot">
                            <strong>${subject.kod_subjek}</strong>
                            <span>Sec ${subject.seksyen}</span>
                            <div class="room-tag"><i class="fa fa-map-marker"></i> ${room}</div>
                        </div>
                    `);
                });
            }
        });
    }

    function displayCourseList(courses) {
        $("#courseListBody").empty();
        courses.forEach(c => {
            $("#courseListBody").append(`
                <tr>
                    <td class="course-code">${c.kod_subjek}</td>
                    <td class="course-name">${c.nama_subjek}</td>
                    <td class="center"><strong>${c.seksyen}</strong></td>
                    <td class="center"><span class="badge-active">ACTIVE</span></td>
                </tr>
            `);
        });
        $("#courseListSection").show();
    }

    function formatTime(m) { return `${8+m}:00 - ${9+m}:00`; }

    function drawFreeTimeChart() {
        const dataArray = [['Day', 'Occupied', 'Free']];
        for (let d = 2; d <= 6; d++) {
            let occ = 0;
            occupiedSlots.forEach(k => { if(k.startsWith(d+'-')) occ++; });
            dataArray.push([DAYS_OF_WEEK[d], occ, HOURS_PER_DAY - occ]);
        }
        const data = google.visualization.arrayToDataTable(dataArray);
        new google.visualization.ColumnChart(document.getElementById('freeTimeChartDiv')).draw(data, {
            isStacked: true,
            colors: ['#10b981', '#f1f5f9'],
            legend: { position: 'top' },
            chartArea: { width: '90%', height: '70%' },
            animation: { startup: true, duration: 800, easing: 'out' }
        });
    }
});
</script>
</body>
</html>