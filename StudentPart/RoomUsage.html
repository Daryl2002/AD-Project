<!DOCTYPE html>
<html>
<head>
    <title>Detailed Room Usage Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        /* Optional style for sticky header on large tables */
        #roomListTable th {
            background-color: #3f51b5; /* Blue-grey header background */
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .w3-table-all {
            /* Sets fixed column widths for better control */
            table-layout: fixed; 
            width: 100%;
        }
        /* Define column widths */
        #roomListTable th:nth-child(1) { width: 5%; } /* No. */
        #roomListTable th:nth-child(2) { width: 10%; } /* Room Code */
        #roomListTable th:nth-child(3) { width: 20%; } /* Room Name */
        #roomListTable th:nth-child(4) { width: 12%; } /* Abbreviated Name */
        #roomListTable th:nth-child(5) { width: 8%; } /* Faculty */
        #roomListTable th:nth-child(6) { width: 8%; } /* Type */
        #roomListTable th:nth-child(7) { width: 8%; } /* Capacity */
        /* Usage columns */
        #roomListTable th:nth-child(8) { width: 14%; } /* Time/Week */
        #roomListTable th:nth-child(9) { width: 15%; } /* No. of Subjects */
    </style>
</head>

<body class="w3-container">

<h2 class="w3-center w3-text-blue">Detailed Room Usage Analysis</h2>

<div class="w3-panel w3-border w3-light-grey w3-round-large w3-padding-16 w3-margin-bottom">
    <p>
        <strong>Session/Semester:</strong> <span id="sessionSem">Loading...</span> 
        <span class="w3-right w3-tag w3-blue-grey w3-round" id="roomCount">0 Rooms Loaded</span>
    </p>
</div>

<div class="loading w3-margin-top" id="loadingMsg">
    ðŸ”„ Fetching list of all rooms...
</div>

<div style="overflow-x: auto;">
    <table class="w3-table-all w3-hoverable w3-card-4" id="roomListTable" style="display:none; min-width: 900px;">
        <thead>
            <tr class="w3-blue-grey">
                <th>No.</th>
                <th>Room Code</th>
                <th>Room Name</th>
                <th>Abbreviated Name</th>
                <th>Faculty</th>
                <th>Type</th>
                <th>Capacity</th>
                <th colspan="2" class="w3-center">Usage</th>
            </tr>
            <tr class="w3-light-grey w3-small">
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th>Time/Week (Hrs)</th>
                <th>Number of Subject</th>
            </tr>
        </thead>
        <tbody id="roomListBody">
            </tbody>
    </table>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
$(document).ready(function() {

    // --- CONSTANTS ---
    // Hardcoded URLs to bypass parent window dependency and fix the 'undefinedruang' error
    const BASE_API_URL = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=";
    const ROOM_LIST_API_URL = BASE_API_URL + "ruang";
    const JADUAL_RUANG_ENTITY = "jadual_ruang";
    
    // --- SESSION CONTEXT ---
    let currentSesi = null;
    let currentSemester = null;
    
    try {
        currentSesi = window.parent.currentSesi;
        currentSemester = window.parent.currentSemester;
    } catch (e) {
        // Fallback or warning if main.html context is inaccessible
        console.warn("Could not access parent window variables. Running page in isolation.");
    }

    if (!currentSesi || !currentSemester) {
        $("#sessionSem").text("Error: Session context unavailable. Cannot calculate usage.");
        $("#loadingMsg").html("âŒ Critical Session/Semester context is missing.");
        return;
    }
    
    $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
    
    // Start the process
    fetchAndAnalyzeRooms();
    
    // =================================================================
    // MASTER CONTROL FUNCTION
    // =================================================================

    /**
     * Executes the sequence: Fetch Rooms -> Fetch Usage for Each Room -> Display Table.
     */
    function fetchAndAnalyzeRooms() {
        // 1. Fetch all rooms (Static data)
        fetch(ROOM_LIST_API_URL)
            .then(res => res.json())
            .then(rooms => {
                if (!Array.isArray(rooms) || rooms.length === 0) {
                     $("#loadingMsg").html("âš ï¸ API returned no room data.");
                     return;
                }

                $("#loadingMsg").text(`â³ Found ${rooms.length} rooms. Calculating usage for current semester...`);
                $("#roomCount").text(`${rooms.length} Rooms Found`);
                
                // 2. Fetch usage for all rooms concurrently
                return analyzeRoomUsage(rooms);
            })
            .then(analyzedRooms => {
                // 3. Display the final table
                displayRoomList(analyzedRooms);
                
                $("#loadingMsg").hide();
                $("#roomListTable").show();
                $("#roomCount").text(`${analyzedRooms.length} Rooms Displayed`);
            })
            .catch(err => {
                console.error("âŒ Fatal Error during analysis:", err);
                $("#loadingMsg").html(`âŒ Fatal Error: ${err.message}. Check browser console for details.`);
            });
    }

    // =================================================================
    // USAGE CALCULATION LOGIC
    // =================================================================

    /**
     * Creates a Promise to fetch the schedule for a single room.
     */
    function fetchRoomSchedule(room) {
        // Construct URL: entity=jadual_ruang&sesi=yyyy/yyyy&semester=[1|2]&kod_ruang=???
        const url = `${BASE_API_URL}${JADUAL_RUANG_ENTITY}&sesi=${currentSesi}&semester=${currentSemester}&kod_ruang=${room.kod_ruang}`;

        return fetch(url)
            .then(res => res.json())
            .then(schedule => {
                return calculateUsage(room, schedule);
            })
            .catch(error => {
                // Log and return 0 usage if schedule fetch fails
                console.warn(`Could not fetch schedule for ${room.kod_ruang}. Assuming 0 usage.`, error);
                return { 
                    ...room, 
                    usageHours: 0, 
                    subjectCount: 0 
                };
            });
    }

    /**
     * Calculates usage metrics from the room's schedule data.
     */
    function calculateUsage(room, schedule) {
        // Time/Week (Hours) is the count of distinct time slots scheduled.
        const usageHours = schedule.length; 
        
        // Number of Subjects: Use a Set to count unique Subject-Section combinations.
        const uniqueSubjects = new Set();
        schedule.forEach(slot => {
            if (slot.kod_subjek && slot.seksyen) {
                // Use a unique key combining code and section (e.g., 'SCSD3613-1')
                uniqueSubjects.add(`${slot.kod_subjek}-${slot.seksyen}`);
            }
        });

        return {
            ...room,
            usageHours: usageHours,
            subjectCount: uniqueSubjects.size
        };
    }

    /**
     * Manages concurrent fetching of usage data for all rooms.
     */
    function analyzeRoomUsage(rooms) {
        const promises = rooms.map(room => fetchRoomSchedule(room));
        // Use Promise.allSettled to ensure all promises finish (success or failure)
        return Promise.allSettled(promises)
            .then(results => {
                // Filter out any promises that failed entirely and extract the fulfilled values
                return results
                    .filter(result => result.status === 'fulfilled')
                    .map(result => result.value);
            });
    }

    // =================================================================
    // DISPLAY LOGIC
    // =================================================================

    /**
     * Populates the room list table body with fetched and analyzed data.
     */
    function displayRoomList(rooms) {
        const body = $("#roomListBody");
        body.empty();
        
        // Sort by Usage Hours (most used first)
        rooms.sort((a, b) => b.usageHours - a.usageHours);

        rooms.forEach((room, index) => {
            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${room.kod_ruang || 'N/A'}</strong></td>
                    <td>${room.nama_ruang || 'N/A'}</td>
                    <td>${room.nama_ruang_singkatan || 'N/A'}</td>
                    <td>${room.kod_fakulti || 'N/A'}</td>
                    <td>${room.jenis || 'N/A'}</td>
                    <td class="w3-center">${room.kapasiti || 'N/A'}</td>
                    <td class="w3-center">
                        <span class="w3-tag w3-teal w3-round">${room.usageHours}</span>
                    </td>
                    <td class="w3-center">
                        <span class="w3-tag w3-indigo w3-round">${room.subjectCount}</span>
                    </td>
                </tr>
            `;
            body.append(row);
        });
        
        console.log(`âœ… Displayed ${rooms.length} rooms with usage data.`);
    }
});
</script>
</body>
</html>