<!DOCTYPE html>
<html>
<head>
    <title>Detailed Room Usage Analysis - FSKSM N28/N28A</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        /* Optional style for sticky header on large tables */
        #roomListTable th {
            background-color: #3f51b5; /* Blue-grey header background */
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .w3-table-all {
            table-layout: fixed; 
            width: 100%;
        }
        /* Define column widths */
        #roomListTable th:nth-child(1) { width: 5%; } /* No. */
        #roomListTable th:nth-child(2) { width: 10%; } /* Room Code */
        #roomListTable th:nth-child(3) { width: 20%; } /* Room Name */
        #roomListTable th:nth-child(4) { width: 12%; } /* Abbreviated Name */
        #roomListTable th:nth-child(5) { width: 8%; } /* Faculty */
        #roomListTable th:nth-child(6) { width: 8%; } /* Type */
        #roomListTable th:nth-child(7) { width: 8%; } /* Capacity */
        /* Usage columns */
        #roomListTable th:nth-child(8) { width: 14%; } /* Time/Week */
        #roomListTable th:nth-child(9) { width: 15%; } /* No. of Subjects */
    </style>
</head>

<body class="w3-container">

<h2 class="w3-center w3-text-blue">Detailed Room Usage Analysis (FSKSM N28/N28A)</h2>

<div class="w3-panel w3-border w3-light-grey w3-round-large w3-padding-16 w3-margin-bottom">
    <p>
        <strong>Session/Semester:</strong> <span id="sessionSem">Loading...</span> 
        <span class="w3-right w3-tag w3-blue-grey w3-round" id="roomCount">0 Rooms Loaded</span>
    </p>
</div>

<div class="loading w3-margin-top" id="loadingMsg">
    ðŸ”„ Fetching FSKSM rooms...
</div>

<div style="overflow-x: auto;">
    <table class="w3-table-all w3-hoverable w3-card-4" id="roomListTable" style="display:none; min-width: 900px;">
        <thead>
            <tr class="w3-blue-grey">
                <th>No.</th>
                <th>Room Code</th>
                <th>Room Name</th>
                <th>Abbreviated Name</th>
                <th>Faculty</th>
                <th>Type</th>
                <th>Capacity</th>
                <th colspan="2" class="w3-center">Usage</th>
            </tr>
            <tr class="w3-light-grey w3-small">
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th>Time/Week (Hrs)</th>
                <th>Number of Subject</th>
            </tr>
        </thead>
        <tbody id="roomListBody">
            </tbody>
    </table>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
$(document).ready(function() {

    // --- CONSTANTS ---
    const BASE_API_URL = "http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=";
    const ROOM_LIST_API_URL_FSKSM = BASE_API_URL + "ruang&kod_fakulti=fsksm";
    const JADUAL_RUANG_ENTITY = "jadual_ruang";
    
    // --- SESSION CONTEXT ---
    let currentSesi = null;
    let currentSemester = null;
    
    // Attempt to get context from parent window (for embedded mode)
    try {
        currentSesi = window.parent.currentSesi;
        currentSemester = window.parent.currentSemester;
    } catch (e) {
        console.warn("Could not access parent window variables. Assuming default context.");
    }
    
    // Provide default values if context is missing for standalone execution
    if (!currentSesi || !currentSemester) {
        currentSesi = "2025/2026"; 
        currentSemester = "1";
        console.warn(`Using default Sesi: ${currentSesi} and Semester: ${currentSemester} for standalone execution.`);
    }
    
    $("#sessionSem").text(`${currentSesi} - Semester ${currentSemester}`);
    
    fetchAndAnalyzeRooms();
    
    // =================================================================
    // MASTER CONTROL FUNCTION
    // =================================================================

    function fetchAndAnalyzeRooms() {
        // 1. Fetch FSKSM rooms
        fetch(ROOM_LIST_API_URL_FSKSM)
            .then(res => res.json())
            .then(rooms => {
                if (!Array.isArray(rooms) || rooms.length === 0) {
                     $("#loadingMsg").html("âš ï¸ API returned no room data for FSKSM.");
                     return;
                }
                
                // 2. Client-side Filter for N28/N28A blocks
                const filteredRooms = rooms.filter(room => {
                    const code = room.kod_ruang;
                    return code && (code.startsWith('N28') || code.startsWith('N28A'));
                });

                if (filteredRooms.length === 0) {
                     $("#loadingMsg").html(`âš ï¸ Found ${rooms.length} FSKSM rooms, but 0 matched N28/N28A prefix.`);
                     return;
                }

                $("#loadingMsg").text(`â³ Found ${filteredRooms.length} N28/N28A rooms. Calculating usage...`);
                $("#roomCount").text(`${filteredRooms.length} Rooms Found`);
                
                // 3. Fetch usage for the filtered rooms concurrently
                return analyzeRoomUsage(filteredRooms);
            })
            .then(analyzedRooms => {
                // 4. Display the final table
                displayRoomList(analyzedRooms);
                
                $("#loadingMsg").hide();
                $("#roomListTable").show();
                $("#roomCount").text(`${analyzedRooms.length} N28/N28A Rooms Displayed`);
            })
            .catch(err => {
                console.error("âŒ Fatal Error during analysis:", err);
                $("#loadingMsg").html(`âŒ Fatal Error: ${err.message}. Check browser console for details.`);
            });
    }

    // =================================================================
    // USAGE CALCULATION LOGIC (FINAL ROBUST UNIQUE SLOT COUNTING)
    // =================================================================

    function fetchRoomSchedule(room) {
        const url = `${BASE_API_URL}${JADUAL_RUANG_ENTITY}&sesi=${currentSesi}&semester=${currentSemester}&kod_ruang=${room.kod_ruang}`;

        return fetch(url)
            .then(res => res.json())
            .then(schedule => {
                if (!Array.isArray(schedule)) {
                    // Treat non-array response as empty schedule
                    return calculateUsage(room, []); 
                }
                return calculateUsage(room, schedule);
            })
            .catch(error => {
                console.error(`âŒ SCHEDULE FETCH ERROR for ${room.kod_ruang}:`, error);
                return { 
                    ...room, 
                    usageHours: 0, 
                    subjectCount: 0 
                };
            });
    }

    function calculateUsage(room, schedule) {
        const uniqueWeeklySlots = new Set();
        const uniqueSubjects = new Set();
        
        schedule.forEach(slot => {
            // Safer way to access nested properties, defaulting to null/0 if object is missing
            const kodSubjek = slot.subjek && slot.subjek.kod_subjek;
            const sekyen = (slot.subjek && slot.subjek.seksyen) || '0'; // Use '0' if section is missing
            const hari = slot.hari;
            const masa = slot.masa;
            
            // --- 1. COUNT UNIQUE SUBJECTS (Bil. Subjek) - FIX: Count unique KOD_SUBJEK only ---
            if (kodSubjek) {
                // Count unique Subject Codes only, ignoring sections
                uniqueSubjects.add(kodSubjek); 
            }

            // --- 2. COUNT USAGE HOURS (Jam/Minggu) - FIX: Count unique weekly slots ---
            if (hari && masa && room.kod_ruang) {
                let uniqueSlotKey;
                
                if (kodSubjek) {
                    // Case A: Subject Class. Key distinguishes based on Subject/Section/Day/Time.
                    uniqueSlotKey = `${kodSubjek}-${sekyen}-${hari}-${masa}`;
                } else {
                    // Case B: Non-Subject Booking (e.g., Meeting Room). 
                    // Key relies on the room code itself to define the unique booking slot.
                    uniqueSlotKey = `NON_SUB_BOOKING-${room.kod_ruang}-${hari}-${masa}`;
                }
                
                uniqueWeeklySlots.add(uniqueSlotKey);
            }
        });
        
        // The total number of unique keys (unique scheduled hours per week) is the Hours/Week
        const usageHours = uniqueWeeklySlots.size;

        return {
            ...room,
            usageHours: usageHours, 
            subjectCount: uniqueSubjects.size
        };
    }

    function analyzeRoomUsage(rooms) {
        const promises = rooms.map(room => fetchRoomSchedule(room));
        return Promise.allSettled(promises)
            .then(results => {
                return results
                    .filter(result => result.status === 'fulfilled')
                    .map(result => result.value);
            });
    }

    // =================================================================
    // DISPLAY LOGIC
    // =================================================================

    function displayRoomList(rooms) {
        const body = $("#roomListBody");
        body.empty();
        
        // Sort in descending order of usage hours
        rooms.sort((a, b) => b.usageHours - a.usageHours);

        rooms.forEach((room, index) => {
            const usageTagColor = room.usageHours > 0 ? 'w3-teal' : 'w3-light-grey w3-text-dark-grey';
            const subjectTagColor = room.subjectCount > 0 ? 'w3-indigo' : 'w3-light-grey w3-text-dark-grey';
            
            const row = `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${room.kod_ruang || 'N/A'}</strong></td>
                    <td>${room.nama_ruang || 'N/A'}</td>
                    <td>${room.nama_ruang_singkatan || 'N/A'}</td>
                    <td>${room.kod_fakulti || 'N/A'}</td>
                    <td>${room.jenis || 'N/A'}</td> 
                    <td class="w3-center">${room.kapasiti || 'N/A'}</td> 
                    <td class="w3-center">
                        <span class="w3-tag ${usageTagColor} w3-round">${room.usageHours}</span>
                    </td>
                    <td class="w3-center">
                        <span class="w3-tag ${subjectTagColor} w3-round">${room.subjectCount}</span>
                    </td>
                </tr>
            `;
            body.append(row);
        });
    }
});
</script>
</body>
</html>