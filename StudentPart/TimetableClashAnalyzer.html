<!DOCTYPE html>
<html lang="en">

<head>
    <title>Timetable Analyzer - Clash Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="../Authenticate.js"></script>
    <script src="../CacheUtil.js"></script>
    <link rel="stylesheet" href="Styles/TimetableClashAnalyzerStyle.css">
</head>

<body>

    <div class="timetable-wrapper">
        <div class="timetable-header">
            <h2>Timetable Clash Analyzer</h2>
            <div class="info-grid">
                <div class="info-stat-card">
                    <label>Student</label>
                    <span id="studentName">Loading...</span>
                </div>
                <div class="info-stat-card">
                    <label>ID No.</label>
                    <span id="matricNo">Loading...</span>
                </div>
                <div class="info-stat-card">
                    <label>Current Term</label>
                    <span id="sessionSem">Loading...</span>
                </div>
            </div>
        </div>

        <div class="loading" id="loadingMsg">
            üîÑ Analyzing timetable for clashes...
        </div>

        <!-- Color Indicators -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #dcfce7; border-color: #22c55e;"></div>
                <span>No Clash</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fee2e2; border-color: #ef4444;"></div>
                <span>Clash Detected</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f8fafc; border-color: #e2e8f0;"></div>
                <span>Empty Slot</span>
            </div>
        </div>

        <!-- Timetable Table -->
        <div class="table-container" id="timetableContainer" style="display:none;">
            <table class="proto-table" id="timetableTable">
                <thead>
                    <tr>
                        <th class="time-header">Time</th>
                        <th>MON</th>
                        <th>TUE</th>
                        <th>WED</th>
                        <th>THU</th>
                        <th>FRI</th>
                    </tr>
                </thead>
                <tbody id="timetableBody"></tbody>
            </table>
        </div>

        <!-- Clash Results Section -->
        <div id="clashResultsSection" class="clash-results-section" style="display:none;">
            <h3 class="section-title">Clash Analysis Results</h3>

            <!-- Detailed Clash Information Table -->
            <div id="clashDetails" style="display:none;">
                <div class="table-container">
                    <table class="clash-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Day</th>
                                <th style="width: 25%;">Time</th>
                                <th style="width: 55%;">Clashing Courses</th>
                            </tr>
                        </thead>
                        <tbody id="clashTableBody">
                            <!-- Clash rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- No Clash Message -->
            <div id="noClashMessage" class="no-clash-message" style="display:none;">
                <h3>No Clashes Detected!</h3>
                <p>Your timetable is perfectly scheduled with no overlapping courses.</p>
            </div>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            // Data structures for tracking
            let timetableData = {}; // Format: { "day-time": [{course1}, {course2}] }
            let totalClashes = 0;
            let clashedSlots = 0;
            let maxClashesInSlot = 0;

            // Day code mapping
            const DAYS_OF_WEEK = {
                2: 'Monday',
                3: 'Tuesday',
                4: 'Wednesday',
                5: 'Thursday',
                6: 'Friday'
            };

            // Day names for display
            const DAY_NAMES = ['', '', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

            // Initialize timetable data structure
            function initializeTimetableData() {
                timetableData = {};
                totalClashes = 0;
                clashedSlots = 0;
                maxClashesInSlot = 0;

                // Initialize all time slots
                for (let day = 2; day <= 6; day++) {
                    for (let time = 1; time <= 10; time++) {
                        const key = `${day}-${time}`;
                        timetableData[key] = [];
                    }
                }
            }

            // ==========================================
            // 1. AUTO-GET MATRIC FROM localStorage
            // ==========================================
            const userSession = JSON.parse(localStorage.getItem("TTMSFC_userSession"));

            if (!userSession) {
                // For demo/testing purposes
                const matric = 'A123456';
                const fullName = 'Demo Student';
                $("#studentName").text(fullName);
                $("#matricNo").text(matric);
            } else {
                const matric = userSession.login_name;
                const fullName = userSession.full_name;
                $("#studentName").text(fullName);
                $("#matricNo").text(matric);
            }

            const matric = $("#matricNo").text();
            const fullName = $("#studentName").text();

            console.log("‚úÖ Auto-detected Matric:", matric);
            console.log("‚úÖ Student Name:", fullName);

            // ==========================================
            // 2. GET CURRENT SESSION/SEMESTER
            // ==========================================
            let currentSesi = window.parent?.currentSesi;
            let currentSemester = window.parent?.currentSemester;

            if (!currentSesi || !currentSemester) {
                fetchCurrentSession().then(() => {
                    loadTimetableForAnalysis(matric, currentSesi, currentSemester);
                });
            } else {
                $("#sessionSem").text(`Sesi ${currentSesi} (Sem ${currentSemester})`);
                loadTimetableForAnalysis(matric, currentSesi, currentSemester);
            }

            // ==========================================
            // FUNCTIONS
            // ==========================================

            function fetchCurrentSession() {
                return cachedFetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester")
                    .then(sessemList => {
                        const active = sessemList.find(s => s.sesi_semester_id) || sessemList[0];
                        currentSesi = active.sesi;
                        currentSemester = active.semester;
                        $("#sessionSem").text(`Sesi ${currentSesi} (Sem ${currentSemester})`);
                        console.log("‚úÖ Fetched session:", currentSesi, currentSemester);
                        return Promise.resolve();
                    })
                    .catch(err => {
                        console.error("‚ùå Error fetching session:", err);
                        $("#sessionSem").text("Error loading session");
                        return Promise.reject(err);
                    });
            }

            function loadTimetableForAnalysis(matric, sesi, semester) {
                initializeTimetableData();
                buildEmptyTable();
                fetchStudentSubjectsForAnalysis(matric, sesi, semester);
            }

            // ==========================================
            // 3. BUILD EMPTY TIMETABLE GRID
            // ==========================================
            function buildEmptyTable() {
                let body = "";
                for (let hour = 1; hour <= 9; hour++) {
                    body += "<tr>";
                    body += `<td class="time-cell">${formatTime(hour)}</td>`;

                    for (let day = 2; day <= 6; day++) {
                        const key = `${day}-${hour}`;
                        body += `<td id="cell-${key}" data-day='${day}' data-time='${hour}'></td>`;
                    }
                    body += "</tr>";
                }
                $("#timetableBody").html(body);
            }

            // ==========================================
            // 4. FETCH STUDENT'S SUBJECTS FOR ANALYSIS
            // ==========================================
            function fetchStudentSubjectsForAnalysis(matric, sesi, semester) {
                const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar_subjek&no_matrik=${matric}`;

                cachedFetch(url)
                    .then(subjects => {
                        const currentSubjects = subjects.filter(s =>
                            s.sesi === sesi && s.semester == semester
                        );

                        if (currentSubjects.length === 0) {
                            $("#loadingMsg").html("‚ö†Ô∏è No subjects found for current semester.");
                            applyHeatmapColors(); // Apply colors even if no subjects
                            return;
                        }

                        let promises = currentSubjects.map(subj => fetchSubjectTimetableForAnalysis(subj));

                        Promise.all(promises).then(() => {
                            analyzeClashes();
                            displayClashResults();
                            applyHeatmapColors();

                            $("#loadingMsg").hide();
                            $("#timetableContainer").show();
                            $("#clashResultsSection").show();
                            console.log("‚úÖ Timetable analysis complete!");
                        });
                    })
                    .catch(err => {
                        console.error("‚ùå Error fetching subjects:", err);
                        $("#loadingMsg").html('<span style="color:#dc2626;">‚ùå Error loading subjects. Please try again.</span>');
                    });
            }

            // ==========================================
            // 5. FETCH TIMETABLE PER SUBJECT FOR ANALYSIS
            // ==========================================
            function fetchSubjectTimetableForAnalysis(subject) {
                const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_subjek&sesi=${subject.sesi}&semester=${subject.semester}&kod_subjek=${subject.kod_subjek}&seksyen=${subject.seksyen}`;

                return cachedFetch(url)
                    .then(times => {
                        if (Array.isArray(times)) {
                            times.forEach(slot => {
                                addCourseToTimetable(subject, slot);
                            });
                        }
                    })
                    .catch(err => {
                        console.error(`‚ùå Error fetching timetable for ${subject.kod_subjek}:`, err);
                    });
            }

            // ==========================================
            // 6. ADD COURSE TO TIMETABLE DATA STRUCTURE
            // ==========================================
            function addCourseToTimetable(subject, slot) {
                const day = slot.hari;
                const time = slot.masa;
                const key = `${day}-${time - 1}`;

                // Add course to this time slot
                const courseData = {
                    kod_subjek: subject.kod_subjek,
                    nama_subjek: subject.nama_subjek,
                    seksyen: subject.seksyen,
                    room: slot.ruang.nama_ruang_singkatan || slot.ruang.kod_ruang || 'N/A'
                };

                timetableData[key].push(courseData);
            }

            // ==========================================
            // 7. ANALYZE CLASHES
            // ==========================================
            function analyzeClashes() {
                // Analyze each time slot
                for (const [slotKey, courses] of Object.entries(timetableData)) {
                    const courseCount = courses.length;

                    if (courseCount > 1) {
                        // This slot has a clash
                        clashedSlots++;
                        totalClashes += (courseCount * (courseCount - 1)) / 2; // n choose 2 for pairwise clashes

                        if (courseCount > maxClashesInSlot) {
                            maxClashesInSlot = courseCount;
                        }
                    }
                }

                console.log("üîç Analysis Results:");
                console.log("- Total clashed slots:", clashedSlots);
                console.log("- Total pairwise clashes:", totalClashes);
                console.log("- Max courses in one slot:", maxClashesInSlot);
            }

            // ==========================================
            // 8. APPLY HEATMAP COLORS TO TIMETABLE
            // ==========================================
            function applyHeatmapColors() {
                // Clear any existing content
                $("td[data-day]").empty();

                // Apply colors and populate courses
                for (const [slotKey, courses] of Object.entries(timetableData)) {
                    const [day, time] = slotKey.split('-');
                    const cell = $(`#cell-${slotKey}`);
                    const courseCount = courses.length;

                    // Remove all previous classes
                    cell.removeClass("slot-clash slot-ok slot-empty");

                    // Apply appropriate class based on course count
                    if (courseCount === 0) {
                        cell.addClass("slot-empty");
                        // Empty slot - leave it empty (no "Empty" text)
                        cell.html('<div class="empty-slot"></div>');
                    } else if (courseCount === 1) {
                        cell.addClass("slot-ok");
                        const course = courses[0];
                        cell.html(`
                            <div class="slot">
                                <strong>${course.kod_subjek} (${course.seksyen})</strong>
                                <span>${course.nama_subjek}</span>
                                <div class="room-tag">üìç ${course.room}</div>
                            </div>
                        `);
                    } else {
                        // Multiple courses = CLASH
                        cell.addClass("slot-clash");

                        let slotHTML = `<div class="slot">`;
                        slotHTML += `<span class="clash-count">${courseCount}</span>`;

                        courses.forEach(course => {
                            slotHTML += `
                                <div class="clash-course-item">
                                    <span class="clash-course-code">${course.kod_subjek} (${course.seksyen})</span><br>
                                    <small>${course.nama_subjek}</small><br>
                                    <span class="room-tag">üìç ${course.room}</span>
                                </div>
                            `;
                        });

                        slotHTML += `</div>`;
                        cell.html(slotHTML);
                    }
                }
            }

            // ==========================================
            // 9. DISPLAY CLASH RESULTS
            // ==========================================
            function displayClashResults() {
                // Show/hide appropriate sections
                if (clashedSlots > 0) {
                    $("#clashDetails").show();
                    $("#noClashMessage").hide();

                    let clashTableHTML = "";

                    // Find all clashed slots and add to table
                    for (const [slotKey, courses] of Object.entries(timetableData)) {
                        if (courses.length > 1) {
                            const [dayCode, time] = slotKey.split('-');
                            const dayName = DAY_NAMES[dayCode];
                            const timeRange = formatTime(parseInt(time));

                            // Create course pairs for display
                            const coursePairs = [];
                            for (let i = 0; i < courses.length; i++) {
                                for (let j = i + 1; j < courses.length; j++) {
                                    const course1 = courses[i];
                                    const course2 = courses[j];
                                    coursePairs.push(
                                        `${course1.kod_subjek} (Sec ${course1.seksyen}) ‚Äì ${course2.kod_subjek} (Sec ${course2.seksyen})`
                                    );
                                }
                            }

                            clashTableHTML += `
                                <tr>
                                    <td class="day-cell">${dayName}</td>
                                    <td class="time-cell-clash">${timeRange}</td>
                                    <td class="clash-courses-cell">
                                        ${coursePairs.join('<br>')}
                                    </td>
                                </tr>
                            `;
                        }
                    }

                    $("#clashTableBody").html(clashTableHTML);
                } else {
                    $("#clashDetails").hide();
                    $("#noClashMessage").show();
                }
            }

            // ==========================================
            // 10. TIME FORMATTING
            // ==========================================
            function formatTime(masa) {
                const start = 7 + masa;
                const end = start + 1;
                return `${start}:00 - ${end}:00`;
            }
        });
    </script>
</body>

</html>