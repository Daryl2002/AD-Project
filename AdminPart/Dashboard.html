<!-- UTM Admin - System Analyzer Dashboard Fragment -->
<style>
    :root {
        /* UTM Corporate Colors */
        --utm-maroon: #540004;
        --utm-gold: #FDBE33;

        /* Dashboard Palette */
        --primary: #6366f1;
        --secondary: #ec4899;
        --accent: #8b5cf6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;

        --bg-body: #f3f4f6;
        --bg-card: rgba(255, 255, 255, 0.9);
        --glass-border: rgba(255, 255, 255, 0.5);

        --text-main: #1f2937;
        --text-muted: #6b7280;
    }

    #dashboard-wrapper {
        padding: 0;
        /* Force immediate horizontal sizing to bypass parent transitions */
        width: calc(100vw - 320px);
    }

    @media (max-width: 992px) {
        #dashboard-wrapper {
            width: calc(100vw - 40px);
        }
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .header-title h1 {
        font-family: 'Outfit', sans-serif;
        font-weight: 700;
        font-size: 1.8rem;
        margin: 0;
        color: #111827;
        letter-spacing: -0.5px;
    }

    .header-title p {
        margin: 5px 0 0;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    /* --- KPI Grid --- */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .kpi-card {
        background: var(--bg-card);
        backdrop-filter: blur(12px);
        border: 1px solid white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .kpi-card:hover {
        transform: translateY(-2px);
    }

    .kpi-icon {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 1.5rem;
        opacity: 0.2;
    }

    .kpi-label {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .kpi-value {
        font-family: 'Outfit', sans-serif;
        font-size: 2.5rem;
        font-weight: 700;
        margin: 10px 0 5px;
        color: #111827;
    }

    .kpi-trend {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* --- Charts Context --- */
    .charts-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #f3f4f6;
        min-height: 450px;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-main);
    }

    /* Loaders */
    .spinner-sm {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--utm-gold);
        animation: spin 1s linear infinite;
    }

    #scatter_div,
    #hist_div {
        opacity: 1;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<div id="dashboard-wrapper">
    <div class="dashboard-header">
        <div class="header-title">
            <h1>System Analyzer</h1>
            <p>Real-time diagnostics for Schedules, Room Usage, and Enrollment efficiency.</p>
        </div>
        <div style="display:flex; gap:10px; align-items: center;">
            <div id="last-update"
                style="font-size:0.85rem; color:var(--text-muted); background:#fff; padding:6px 12px; border-radius:30px; border:1px solid #e5e7eb;">
                Sem: <strong id="currentSemBadge">...</strong>
            </div>
        </div>
    </div>

    <!-- KPI Grid -->
    <div class="kpi-grid">
        <!-- Card 1: Risk (Clashes) -->
        <div class="kpi-card"
            style="border-top: 4px solid var(--danger); box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.1);">
            <div class="kpi-icon"><i class="fas fa-triangle-exclamation" style="color:var(--danger)"></i></div>
            <div class="kpi-label" style="color:var(--danger);">Risk Level (Clashes)</div>
            <div class="kpi-value" id="kpi-clash-count">0</div>
            <div class="kpi-trend" id="kpi-clash-detail">Scanning...</div>
        </div>

        <!-- Card 2: Room Efficiency -->
        <div class="kpi-card"
            style="border-top: 4px solid var(--success); box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.1);">
            <div class="kpi-icon"><i class="fas fa-building-circle-check" style="color:var(--success)"></i></div>
            <div class="kpi-label" style="color:var(--success);">Active Utilization</div>
            <div class="kpi-value" id="kpi-util-rate">0%</div>
            <div class="kpi-trend" id="kpi-util-text">Avg. Weekly Load</div>
        </div>

        <!-- Card 3: Optimization Opportunity -->
        <div class="kpi-card"
            style="border-top: 4px solid #fca311; box-shadow: 0 10px 15px -3px rgba(252, 163, 17, 0.1);">
            <div class="kpi-icon"><i class="fas fa-compress-arrows-alt" style="color:#fca311"></i></div>
            <div class="kpi-label" style="color:#fca311;">Inefficient Classes</div>
            <div class="kpi-value" id="kpi-inefficient">0</div>
            <div class="kpi-trend">Enrollment < 10% Capacity</div>
            </div>

            <!-- Card 4: System Load -->
            <div class="kpi-card"
                style="border-top: 4px solid var(--primary); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.1);">
                <div class="kpi-icon"><i class="fas fa-server" style="color:var(--primary)"></i></div>
                <div class="kpi-label" style="color:var(--primary);">Total Enrollment</div>
                <div class="kpi-value" id="kpi-enrollment">0</div>
                <div class="kpi-trend" id="kpi-subjects-count">... Subjects active</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="charts-row">
            <div class="chart-card">
                <div class="card-header" style="flex-direction:column; align-items:flex-start;">
                    <div class="card-title">Room Optimization Map <span
                            style="font-size:0.8rem; font-weight:400; color:#6b7280; margin-left:10px;">(Capacity vs.
                            Usage)</span></div>
                    <div
                        style="font-size:0.75rem; background:#f9fafb; padding:12px; border-radius:8px; margin-top:10px; color:#4b5563; line-height:1.4; width:100%; border:1px solid #eee;">
                        <strong>Output Guide:</strong><br>
                        • <span style="color:#ef4444;">● Red</span>: <strong>Underutilized</strong> (Used < 20% of
                            week).<br>
                            • <span style="color:#10b981;">● Green</span>: <strong>High Usage</strong> (Used > 60% of
                            week).<br>
                            • <span style="color:#3b82f6;">● Blue</span>: <strong>Balanced</strong> usage.
                    </div>
                </div>
                <div id="scatter_div" style="width: 100%; height: 450px;">
                    <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#9ca3af;">
                        <div class="spinner-sm" style="margin-right:10px;"></div> Discovery in progress...
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="card-header">
                    <div class="card-title">Workload Distribution</div>
                </div>
                <div id="hist_div" style="width: 100%; height: 450px;">
                    <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#9ca3af;">
                        <div class="spinner-sm" style="margin-right:10px;"></div> Loading distribution...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            // --- State ---
            let currentSesi = '2025/2026';
            let currentSem = '1';

            // --- Init Cycle ---
            const checkReady = setInterval(() => {
                if (window.jQuery && window.CacheUtil && window.google) {
                    clearInterval(checkReady);

                    google.charts.load('current', { 'packages': ['corechart'] });
                    google.charts.setOnLoadCallback(async () => {
                        const sessionReady = await initSession();
                        if (sessionReady) {
                            // DRAW DIRECTLY: The rigid CSS width above ensures the container
                            // is already the correct size. No delay needed.
                            await runDiagnostics();
                        }
                    });

                    // Silent background resizing
                    const wrapper = document.getElementById('dashboard-wrapper');
                    if (wrapper && window.ResizeObserver) {
                        const ro = new ResizeObserver(() => {
                            if (lastSubjects) drawDistribution(lastSubjects);
                            if (lastResults) drawEfficiencyMap(lastResults);
                        });
                        ro.observe(wrapper);
                    }
                }
            }, 100);

            let lastSubjects = null;
            let lastResults = null;

            async function initSession() {
                try {
                    const fetchFn = window.cachedFetch || (window.CacheUtil ? window.CacheUtil.fetch : null);
                    if (!fetchFn) return false;

                    const sesiData = await fetchFn("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester");
                    if (sesiData && sesiData.length > 0) {
                        currentSesi = sesiData[0].sesi;
                        currentSem = sesiData[0].semester;
                        $('#currentSemBadge').text(`${currentSesi} - Sem ${currentSem}`);
                        return true;
                    }
                    return false;
                } catch (e) {
                    console.error("Session Init Error:", e);
                    return false;
                }
            }

            // --- Core Scan Implementation ---
            window.runDiagnostics = async function () {
                try {
                    const fetchFn = window.cachedFetch || (window.CacheUtil ? window.CacheUtil.fetch : null);
                    if (!fetchFn) throw new Error("Utilities not loaded");

                    // 1. Fetch Shared Datasets
                    const pSubjects = fetchFn(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=subjek_seksyen&sesi=${currentSesi}&semester=${currentSem}`);
                    const pRooms = fetchFn("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=ruang&kod_fakulti=fsksm");

                    const [subjects, rooms] = await Promise.all([pSubjects, pRooms]);

                    const allSubjects = Array.isArray(subjects) ? subjects : [];
                    const allRooms = Array.isArray(rooms) ? rooms : [];

                    // 2. Metrics Calculation
                    lastSubjects = allSubjects;
                    processEnrollment(allSubjects);
                    processEfficiency(allSubjects);
                    await analyzeConflicts(allRooms);

                } catch (e) {
                    console.error("Diagnostic Failure:", e);
                }
            };

            // --- Metric Helpers ---
            function processEnrollment(subjects) {
                let total = 0;
                const unique = new Set();
                subjects.forEach(s => {
                    total += parseInt(s.bil_pelajar || 0);
                    unique.add(s.kod_subjek);
                });

                animateValue("kpi-enrollment", 0, total, 1500);
                $('#kpi-subjects-count').text(`${unique.size} Active Subjects`);
            }

            function processEfficiency(subjects) {
                let inefficient = 0;
                subjects.forEach(s => {
                    const size = parseInt(s.bil_pelajar || 0);
                    if (size > 0 && size < 10) inefficient++;
                });

                animateValue("kpi-inefficient", 0, inefficient, 1500);
                drawDistribution(subjects);
            }

            async function analyzeConflicts(rooms) {
                const fetchFn = window.cachedFetch || (window.CacheUtil ? window.CacheUtil.fetch : null);
                const n28Rooms = rooms.filter(r => r.kod_ruang && r.kod_ruang.startsWith('N28')).slice(0, 30);

                const promises = n28Rooms.map(r =>
                    fetchFn(`http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=jadual_ruang&sesi=${currentSesi}&semester=${currentSem}&kod_ruang=${r.kod_ruang}`)
                        .then(sched => ({ room: r, sched: sched || [] }))
                        .catch(() => ({ room: r, sched: [] }))
                );

                const results = await Promise.all(promises);

                let slotsTotal = 0, slotsUsed = 0, overlaps = 0;

                results.forEach(res => {
                    const occupancy = new Set();
                    res.sched.forEach(s => {
                        const key = `${s.hari}-${s.masa}`;
                        if (occupancy.has(key)) overlaps++;
                        occupancy.add(key);
                    });
                    slotsTotal += 50;
                    slotsUsed += occupancy.size;
                });

                const utilRate = Math.round((slotsUsed / slotsTotal) * 100);

                animateValue("kpi-clash-count", 0, overlaps, 1500);
                $('#kpi-clash-detail').html(overlaps > 0 ? '<span class="trend-down">Schedule Conflicts</span>' : '<span class="trend-up">Clean Sync</span>');
                animateValue("kpi-util-rate", 0, utilRate, 1500, "%");

                lastResults = results;
                drawEfficiencyMap(results);
            }

            // --- Visualizations ---
            function drawDistribution(subjects) {
                if (!google.visualization) return;

                const data = new google.visualization.DataTable();
                data.addColumn('string', 'Subject');
                data.addColumn('number', 'Students');

                const topClasses = subjects
                    .map(s => ([s.kod_subjek, (parseInt(s.bil_pelajar) || 0)]))
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                if (topClasses.length === 0) {
                    document.getElementById('hist_div').innerHTML = '<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#9ca3af;">No workload data available.</div>';
                    return;
                }

                data.addRows(topClasses);

                const options = {
                    title: 'Top 10 Course by number of student',
                    legend: { position: 'none' },
                    colors: ['#FDBE33'], // UTM Gold
                    hAxis: { title: 'Students', gridlines: { color: '#f3f4f6' }, titleTextStyle: { italic: false, color: '#666' } },
                    vAxis: { textStyle: { fontSize: 11, color: '#444' } },
                    chartArea: { width: '98%', height: '75%', left: '80', top: '20', bottom: '60', right: '10' },
                    backgroundColor: 'transparent',
                    animation: { startup: false }, // Disable startup animation for "Direct" appearance
                    bar: { groupWidth: '75%' }
                };

                const chart = new google.visualization.BarChart(document.getElementById('hist_div'));
                chart.draw(data, options);
            }

            function drawEfficiencyMap(results) {
                if (!google.visualization) return;

                const data = new google.visualization.DataTable();
                data.addColumn('number', 'Utilization %');
                data.addColumn('number', 'Capacity');
                data.addColumn({ type: 'string', role: 'style' });
                data.addColumn({ type: 'string', role: 'tooltip', p: { html: true } });

                const rows = results.map(res => {
                    const sched = Array.isArray(res.sched) ? res.sched : [];
                    const util = Math.round((sched.length / 50) * 100);
                    const cap = (parseInt(res.room.kapasiti) || 0);

                    let color = '#3b82f6', status = 'Balanced', statusBg = '#eff6ff';
                    if (util < 20) { color = '#ef4444'; status = 'Low Use'; statusBg = '#fef2f2'; }
                    else if (util > 60) { color = '#10b981'; status = 'Optimized'; statusBg = '#ecfdf5'; }

                    const tip = `
                    <div style="padding:12px; min-width:180px; font-family:Inter,sans-serif;">
                        <div style="font-weight:700; margin-bottom:4px;">${res.room.kod_ruang || 'Unknown'}</div>
                        <span style="background:${statusBg}; color:${color}; padding:2px 8px; border-radius:10px; font-weight:600; font-size:0.7rem;">${status}</span>
                        <div style="margin-top:8px; font-size:0.8rem;">Util: <b>${util}%</b> | Seats: <b>${cap}</b></div>
                    </div>
                `;

                    return [util, cap, `fill-color: ${color}; stroke-color: #fff; stroke-width: 1;`, tip];
                });

                if (rows.length === 0) {
                    document.getElementById('scatter_div').innerHTML = '<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#9ca3af;">No optimization data available.</div>';
                    return;
                }

                data.addRows(rows);

                const options = {
                    title: 'Room Optimization Map (Capacity vs Efficiency)',
                    hAxis: { title: 'Utilization (%)', minValue: 0, maxValue: 100, gridlines: { color: '#f3f4f6' }, titleTextStyle: { italic: false, color: '#666' } },
                    vAxis: { title: 'Capacity (Seats)', minValue: 0, gridlines: { color: '#f3f4f6' }, titleTextStyle: { italic: false, color: '#666' } },
                    legend: 'none',
                    tooltip: { isHtml: true },
                    chartArea: { width: '98%', height: '75%', left: '40', top: '30', bottom: '60', right: '10' },
                    backgroundColor: 'transparent',
                    animation: { startup: false }, // Disable startup animation for "Direct" appearance
                    pointSize: 10,
                    dataOpacity: 0.8
                };

                const chart = new google.visualization.ScatterChart(document.getElementById('scatter_div'));
                chart.draw(data, options);
            }

            // --- Premium Animation ---
            function animateValue(id, start, end, duration, suffix = "") {
                const obj = document.getElementById(id);
                if (!obj) return;
                let startT = null;
                const step = (t) => {
                    if (!startT) startT = t;
                    const progress = Math.min((t - startT) / duration, 1);
                    const val = Math.floor(progress * (end - start) + start);
                    obj.innerHTML = val.toLocaleString() + suffix;
                    if (progress < 1) window.requestAnimationFrame(step);
                };
                window.requestAnimationFrame(step);
            }
        })();
    </script>