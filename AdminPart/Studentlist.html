<html>
<link rel="stylesheet" href="Styles/studentList.css">

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Student Analysis</h1>
        <div class="search-bar">
            <i class="fa fa-search search-icon"></i>
            <input type="text" id="studentSearch" class="search-input" placeholder="Filter displayed students...">
        </div>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 60px;">Bil.</th>
                        <th>Nama</th>
                        <th>Tahun / Kursus</th>
                        <th>Fakulti</th>
                        <th style="text-align: center;">Bil. Subjek</th>
                        <!-- <th style="text-align: center;">Jumlah Kredit</th> -->
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    <!-- Rows will be populated here -->
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                            <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <p>Loading student data...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-footer">
            <span class="page-info">Showing <span id="startIdx">0</span> to <span id="endIdx">0</span></span>
            <div id="paginationContainer" class="pagination-numbers">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const adminSession = JSON.parse(localStorage.getItem("TTMSFC_adminSession"));
        let currentSesi = null;
        let currentSem = null;

        let offset = 0;
        const limit = 20;

        // Fetch Session Info First
        async function init() {
            try {
                // 1. Get Academic Session
                const res = await fetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester");
                const data = await res.json();

                // Pick the first entry as the current active session
                if (Array.isArray(data) && data.length > 0) {
                    currentSesi = data[0].sesi;
                    currentSem = data[0].semester;
                } else {
                    throw new Error("No active session found.");
                }

                // 2. Load Students
                loadStudents();
            } catch (err) {
                console.error("Failed to init student list", err);
                $('#studentTableBody').html(`<tr><td colspan="5" style="text-align:center; color:red;">Failed to load data.</td></tr>`);
            }
        }

        async function loadStudents() {
            $('#studentTableBody').html(`
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Fetching students...</p>
                    </td>
                </tr>
            `);

            try {
                const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar&session_id=${adminSession.session_id}&sesi=${currentSesi}&semester=${currentSem}&limit=${limit}&offset=${offset}`;

                const response = await fetch(url);
                const students = await response.json();

                if (!Array.isArray(students)) {
                    throw new Error("Invalid response format");
                }

                renderTable(students);
                updatePagination(students.length);
            } catch (err) {
                console.error(err);
                $('#studentTableBody').html(`<tr><td colspan="5" style="text-align:center; color:red;">Error loading students.</td></tr>`);
            }
        }

        function renderTable(students) {
            const tbody = $('#studentTableBody');
            tbody.empty();

            if (students.length === 0) {
                tbody.html(`<tr><td colspan="5" style="text-align:center;">No students found.</td></tr>`);
                return;
            }

            students.forEach((s, index) => {
                const row = `
                    <tr>
                        <td style="color:var(--text-muted); font-size:0.85rem;">${index + 1}</td>
                        <td>
                            <div style="font-weight:600; color:var(--text-main);">${s.nama}</div>
                        </td>
                        <td>
                             <span style="font-weight:600;">${s.tahun_kursus}</span> 
                             <span style="color:var(--text-muted); margin-left:4px;">${s.kod_kursus}</span>
                        </td>
                        <td><span class="badge badge-primary">${s.kod_fakulti}</span></td>
                        <td style="text-align: center;">
                            <a href="#" style="font-weight:600; text-decoration:underline; color:#2563eb;">
                                ${s.bil_subjek}
                            </a>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        let currentPage = 1;

        function updatePagination(count) {
            $('#startIdx').text(offset + 1);
            $('#endIdx').text(offset + count);

            const container = $('#paginationContainer');
            container.empty();

            // Prev Button
            const prevBtn = $('<button class="page-num"><i class="fa fa-angle-left"></i></button>');
            if (currentPage === 1) prevBtn.prop('disabled', true);
            prevBtn.click(() => goToPage(currentPage - 1));
            container.append(prevBtn);


            // Page Numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = currentPage + 2;

            // If we received fewer items than limit, we know this is the last page (or past it)
            const isLastPage = count < limit;

            if (isLastPage) endPage = currentPage;

            for (let i = startPage; i <= endPage; i++) {
                const btn = $(`<button class="page-num">${i}</button>`);
                if (i === currentPage) btn.addClass('active');
                btn.click(() => goToPage(i));
                container.append(btn);
            }

            // Next Button
            const nextBtn = $('<button class="page-num"><i class="fa fa-angle-right"></i></button>');
            if (isLastPage) nextBtn.prop('disabled', true);
            nextBtn.click(() => goToPage(currentPage + 1));
            container.append(nextBtn);
        }

        function goToPage(pageNum) {
            if (pageNum < 1) return;
            currentPage = pageNum;
            offset = (pageNum - 1) * limit;
            loadStudents();
        }

        // Search - Client Side Filter
        $('#studentSearch').on('keyup', function () {
            const value = $(this).val().toLowerCase();
            const rows = $("#studentTableBody tr");
            let visibleCount = 0;

            rows.each(function () {
                // Column 2 contains Name & Matric (index 1 in 0-based eq check? No, td indices)
                const nameMetricText = $(this).find('td:nth-child(2)').text().toLowerCase();
                const shouldShow = nameMetricText.indexOf(value) > -1;

                $(this).toggle(shouldShow);
                if (shouldShow) visibleCount++;
            });

            // Handle "No results" message
            $('#no-results-row').remove();
            if (visibleCount === 0 && value.length > 0) {
                $('#studentTableBody').append(`
                    <tr id="no-results-row">
                        <td colspan="5" style="text-align:center; color:var(--text-muted); padding:20px;">
                            No matches found on this page.
                        </td>
                    </tr>
                `);
            }
        });

        // Start
        init();
    })();
</script>

</html>