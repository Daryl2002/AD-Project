<html>
<script src="../Authenticate.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="stylesheet" href="Styles/studentList.css">

<style>
    .charts-row {
        display: flex;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
    }

    .chart-card {
        flex: 1;
        min-width: 300px;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        height: 350px;
        /* Fixed height for consistency */
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 10px;
        text-align: center;
    }
</style>

<div class="page-container">
    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 5px;">
        <h1 class="page-title" style="margin-right: auto;">Student Analysis</h1>

        <!-- Year Filter -->
        <!-- Year Filter -->
        <select id="yearFilter" class="filter-select" multiple style="display:none;">
            <!-- Populated dynamically -->
        </select>

        <!-- Course Filter -->
        <select id="courseFilter" class="filter-select" multiple style="display:none;">
            <option value="">All Courses</option>
            <!-- Populated dynamically -->
        </select>

        <!-- Search Bar -->
        <div class="search-bar">
            <i class="fa fa-search search-icon"></i>
            <input type="text" id="studentSearch" class="search-input" placeholder="Search by name...">
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="charts-row">
    <div class="chart-card">
        <div class="chart-title">Students by Course</div>
        <div id="courseChart" style="width: 100%; height: 300px;"></div>
    </div>
    <div class="chart-card">
        <div class="chart-title">Students by Year</div>
        <div id="yearChart" style="width: 100%; height: 300px;"></div>
    </div>
</div>

<div class="table-card">
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 60px;">No.</th>
                    <th>Name</th>
                    <th>Year / Course</th>
                    <th>Faculty</th>
                    <th>No. of Subjects</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Loading student database...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-footer">
        <span class="page-info">Showing <span id="startIdx">0</span> to <span id="endIdx">0</span> of <span
                id="totalCount">0</span> entries</span>
        <div id="paginationContainer" class="pagination-numbers"></div>
    </div>
</div>
</div>

<script>
    (function () {
        const adminSession = JSON.parse(localStorage.getItem("TTMSFC_adminSession"));
        let currentSesi = null;
        let currentSem = null;

        // Chart State
        let isChartLibReady = false;

        function initCharts() {
            if (typeof google === 'undefined' || !google.charts) {
                setTimeout(initCharts, 100);
                return;
            }
            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(() => {
                isChartLibReady = true;
                if (typeof filteredStudents !== 'undefined' && filteredStudents.length > 0) {
                    drawCharts();
                }
            });
        }
        initCharts();

        // State
        let allStudents = [];       // Master list fetched from API
        let filteredStudents = [];  // List after search/filter applied
        let uniqueCourses = new Set();
        let uniqueYears = new Set();

        // Pagination State
        let currentPage = 1;
        const itemsPerPage = 20;

        // Init
        async function init() {
            try {
                // 1. Get Session
                const res = await fetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester");
                const data = await res.json();
                if (Array.isArray(data) && data.length > 0) {
                    currentSesi = data[0].sesi;
                    currentSem = data[0].semester;
                } else {
                    throw new Error("No active session found.");
                }

                // 2. Fetch ALL Students 
                // We fetch a large batch to enable client-side slicing/dicing
                await fetchAndCacheStudents();

            } catch (err) {
                console.error("Init failed", err);
                $('#studentTableBody').html(`<tr><td colspan="5" style="text-align:center; color:red;">Failed to connect to database.</td></tr>`);
            }
        }

        async function fetchAndCacheStudents() {
            try {
                allStudents = []; // Reset
                let fetchOffset = 0;
                const batchLimit = 1000; // API likely caps at this
                let keepFetching = true;

                while (keepFetching) {
                    // Update UI 
                    $('#studentTableBody').html(`
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                                <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p>Loading student list for analysis...</p>
                            </td>
                        </tr>
                    `);

                    const url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar&session_id=${adminSession.session_id}&sesi=${currentSesi}&semester=${currentSem}&limit=${batchLimit}&offset=${fetchOffset}`;

                    const response = await fetch(url);
                    const students = await response.json();

                    if (!Array.isArray(students)) throw new Error("Invalid format");

                    if (students.length === 0) {
                        break; // Done
                    }

                    allStudents = allStudents.concat(students);
                    fetchOffset += students.length;

                    // If we got fewer than the limit, we've reached the end
                    if (students.length < batchLimit) {
                        keepFetching = false;
                    }
                }

                // Populate Filters
                populateFilters(allStudents);

                // Initial Render
                applyFilters();

            } catch (err) {
                console.error(err);
                $('#studentTableBody').html(`<tr><td colspan="5" style="text-align:center; color:red;">Error fetching student list.</td></tr>`);
            }
        }

        function populateFilters(students) {
            uniqueCourses.clear();
            uniqueYears.clear();

            students.forEach(s => {
                if (s.kod_kursus) uniqueCourses.add(s.kod_kursus);
                if (s.tahun_kursus) uniqueYears.add(s.tahun_kursus);
            });

            // 1. Courses
            const sortedCourses = Array.from(uniqueCourses).sort();
            const courseSelect = $('#courseFilter');
            let courseHtml = '';
            sortedCourses.forEach(c => courseHtml += `<option value="${c}">${c}</option>`);
            courseSelect.html(courseHtml);
            createMultiSelect('#courseFilter', 'All Courses');

            // 2. Years
            const sortedYears = Array.from(uniqueYears).sort((a, b) => a - b);
            const yearSelect = $('#yearFilter');
            let yearHtml = '';
            sortedYears.forEach(y => yearHtml += `<option value="${y}">Year ${y}</option>`);
            yearSelect.html(yearHtml);
            createMultiSelect('#yearFilter', 'All Years');
        }

        // Generic Multi-Select Creator
        function createMultiSelect(selector, defaultLabel) {
            const select = $(selector);
            const wrapperId = `custom-${select.attr('id')}`;

            // Cleanup existing
            $(`#${wrapperId}`).remove();

            const wrapper = $(`<div class="custom-select-wrapper" id="${wrapperId}"></div>`);
            const trigger = $(`<div class="custom-select-trigger"><span>${defaultLabel}</span><div class="arrow"></div></div>`);
            const optionsContainer = $('<div class="custom-options"></div>');

            // Add options with checkboxes
            select.find('option').each(function () {
                const optVal = $(this).val();
                const optText = $(this).text();

                const optionEl = $(`
                    <div class="custom-option" data-value="${optVal}">
                        <input type="checkbox" checked style="pointer-events:none; margin-right:8px;"> ${optText}
                    </div>
                `);

                // Click Handler
                optionEl.click(function (e) {
                    e.stopPropagation();
                    const checkbox = $(this).find('input');
                    const isChecked = !checkbox.prop('checked'); // Toggle
                    checkbox.prop('checked', isChecked);
                    $(this).toggleClass('selected', isChecked);

                    // Sync with native select
                    const checkedValues = [];
                    optionsContainer.find('input:checked').each(function () {
                        checkedValues.push($(this).closest('.custom-option').data('value'));
                    });

                    select.val(checkedValues).trigger('change');

                    // Update Trigger Text
                    if (checkedValues.length === 0) {
                        trigger.find('span').text("None Selected");
                    } else if (checkedValues.length === select.find('option').length) {
                        trigger.find('span').text(defaultLabel);
                    } else {
                        trigger.find('span').text(`${checkedValues.length} Selected`);
                    }
                });

                // Initially selected
                optionEl.addClass('selected');
                optionsContainer.append(optionEl);
            });

            // Set native select to all initially
            const allVals = select.find('option').map((_, el) => $(el).val()).get();
            select.val(allVals);

            // Toggle Open
            trigger.click(function (e) {
                e.stopPropagation();
                $('.custom-select-wrapper').not(wrapper).removeClass('open');
                wrapper.toggleClass('open');
            });

            wrapper.append(trigger);
            wrapper.append(optionsContainer);
            select.after(wrapper);

            // Close on outside click
            $(document).on('click', function () {
                wrapper.removeClass('open');
            });
        }

        // --- Filtering Logic ---
        function applyFilters() {
            const searchTerm = $('#studentSearch').val().toLowerCase().trim();

            // Get arrays of selected values
            const selectedCourses = $('#courseFilter').val() || [];
            const selectedYears = $('#yearFilter').val() || [];

            filteredStudents = allStudents.filter(s => {
                // 1. Text Search (Name or Matric)
                const matchesSearch = !searchTerm ||
                    (s.nama && s.nama.toLowerCase().includes(searchTerm)) ||
                    (s.no_matrik && s.no_matrik.toLowerCase().includes(searchTerm));

                // 2. Course Filter
                // Note: user might uncheck all -> usually means show none, but we initialized all checked.
                const matchesCourse = selectedCourses.includes(s.kod_kursus);

                // 3. Year Filter
                // Ensure type match (API string vs val string)
                const matchesYear = selectedYears.includes(String(s.tahun_kursus));

                return matchesSearch && matchesCourse && matchesYear;
            });

            // Reset to page 1 whenever filters change
            currentPage = 1;
            renderCurrentPage();

            // Draw Charts
            if (isChartLibReady) drawCharts();
        }

        function renderCurrentPage() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageSlice = filteredStudents.slice(start, end);

            renderTable(pageSlice, start);
            updatePagination();
        }

        function drawCharts() {
            if (!filteredStudents || filteredStudents.length === 0) {
                $('#courseChart, #yearChart').html('<p style="text-align:center; padding-top:140px; color:#aaa;">No Data</p>');
                return;
            }

            // 1. Course Data
            const courseCounts = {};
            filteredStudents.forEach(s => {
                const c = s.kod_kursus || 'Unknown';
                courseCounts[c] = (courseCounts[c] || 0) + 1;
            });
            const courseData = [['Course', 'Count']];
            // Sort by count desc
            Object.entries(courseCounts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([k, v]) => courseData.push([k, v]));

            // 2. Year Data
            const yearCounts = {};
            filteredStudents.forEach(s => {
                const y = s.tahun_kursus ? `Year ${s.tahun_kursus}` : 'Unknown';
                yearCounts[y] = (yearCounts[y] || 0) + 1;
            });
            const yearData = [['Year', 'Count']];
            Object.entries(yearCounts)
                .sort((a, b) => a[0].localeCompare(b[0])) // Sort by year
                .forEach(([k, v]) => yearData.push([k, v]));

            // Base Options
            const options = {
                pieHole: 0.4,
                chartArea: { width: '90%', height: '80%' },
                legend: { position: 'right', textStyle: { fontSize: 12 } },
                colors: ['#2563eb', '#34d399', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1'],
                fontName: 'Inter'
            };

            // Draw Course Chart
            const cChart = new google.visualization.PieChart(document.getElementById('courseChart'));
            cChart.draw(google.visualization.arrayToDataTable(courseData), options);

            // Draw Year Chart
            const yChart = new google.visualization.PieChart(document.getElementById('yearChart'));
            yChart.draw(google.visualization.arrayToDataTable(yearData), options);
        }

        function renderTable(data, startIndex) {
            const tbody = $('#studentTableBody');
            tbody.empty();

            if (data.length === 0) {
                tbody.html(`<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">No matching students found.</td></tr>`);
                $('#startIdx').text(0);
                $('#endIdx').text(0);
                $('#totalCount').text(0);
                return;
            }

            // Update Info Text
            $('#startIdx').text(startIndex + 1);
            $('#endIdx').text(startIndex + data.length);
            $('#totalCount').text(filteredStudents.length);

            data.forEach((s, index) => {
                const row = `
                    <tr>
                        <td style="color:var(--text-muted); font-size:0.85rem;">${startIndex + index + 1}</td>
                        <td>
                            <div style="font-weight:600; color:var(--text-main);">${s.nama}</div>
                        </td>
                        <td>
                             <span style="font-weight:600;">${s.tahun_kursus}</span> 
                             <span style="color:var(--text-muted); margin-left:4px;">${s.kod_kursus}</span>
                        </td>
                        <td><span class="badge badge-primary">${s.kod_fakulti}</span></td>
                        <td>
                            <span style="font-weight:600; color:var(--text-main);">${s.bil_subjek}</span>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function updatePagination() {
            const container = $('#paginationContainer');
            container.empty();

            const totalPages = Math.ceil(filteredStudents.length / itemsPerPage);
            if (totalPages <= 1) return; // Hide if only 1 page

            // Prev
            const prevBtn = $('<button class="page-num"><i class="fa fa-angle-left"></i></button>');
            prevBtn.prop('disabled', currentPage === 1);
            prevBtn.click(() => goToPage(currentPage - 1));
            container.append(prevBtn);

            // Limited Page Numbers (Sliding Window)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);

            if (endPage - startPage < 4) {
                if (startPage === 1) endPage = Math.min(totalPages, 5);
                else if (endPage === totalPages) startPage = Math.max(1, totalPages - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = $(`<button class="page-num">${i}</button>`);
                if (i === currentPage) btn.addClass('active');
                btn.click(() => goToPage(i));
                container.append(btn);
            }

            // Next
            const nextBtn = $('<button class="page-num"><i class="fa fa-angle-right"></i></button>');
            nextBtn.prop('disabled', currentPage === totalPages);
            nextBtn.click(() => goToPage(currentPage + 1));
            container.append(nextBtn);
        }

        function goToPage(pageNum) {
            currentPage = pageNum;
            renderCurrentPage(); // Render local slice
        }

        // Listeners
        let searchTimeout;
        $('#studentSearch').on('keyup', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300); // 300ms debounce
        });

        $('#courseFilter').on('change', function () {
            applyFilters();
        });

        // Run
        init();
    })();
</script>

</html>