<html>
<link rel="stylesheet" href="Styles/studentList.css">

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Student Analysis</h1>
        <div class="search-bar">
            <i class="fa fa-search search-icon"></i>
            <input type="text" id="studentSearch" class="search-input" placeholder="Filter displayed students...">
        </div>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 60px;">Bil.</th>
                        <th>Nama</th>
                        <th>Tahun / Kursus</th>
                        <th>Fakulti</th>
                        <th style="text-align: center;">Bil. Subjek</th>
                        <!-- <th style="text-align: center;">Jumlah Kredit</th> -->
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    <!-- Rows will be populated here -->
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                            <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <p>Loading student data...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-footer">
            <span class="page-info">Showing <span id="startIdx">0</span> to <span id="endIdx">0</span></span>
            <div id="paginationContainer" class="pagination-numbers">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const adminSession = JSON.parse(localStorage.getItem("TTMSFC_adminSession"));
        let currentSesi = null;
        let currentSem = null;
        let currentSearchQuery = "";

        let offset = 0;
        const limit = 20;

        // Fetch Session Info First
        async function init() {
            try {
                // 1. Get Academic Session
                const res = await fetch("http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=sesisemester");
                const data = await res.json();

                // Pick the first entry as the current active session
                if (Array.isArray(data) && data.length > 0) {
                    currentSesi = data[0].sesi;
                    currentSem = data[0].semester;
                } else {
                    throw new Error("No active session found.");
                }

                // 2. Load Students
                loadStudents();
            } catch (err) {
                console.error("Failed to init student list", err);
                $('#studentTableBody').html(`<tr><td colspan="5" style="text-align:center; color:red;">Failed to load data.</td></tr>`);
            }
        }

        // Global cache for search results
        let allSearchResults = [];

        async function loadStudents() {
            $('#studentTableBody').html(`
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>${currentSearchQuery ? "Searching entire database..." : "Fetching students..."}</p>
                    </td>
                </tr>
            `);

            try {
                // DATA FETCHING STRATEGY:
                // If Searching: Fetch ALL (high limit) and filter Client-Side.
                // If Browsing: Use Server-Side Pagination.

                let fetchLimit = limit;
                let fetchOffset = offset;

                if (currentSearchQuery) {
                    // Fetch "all" (limit 5000 should cover most courses/faculties)
                    fetchLimit = 5000;
                    fetchOffset = 0;
                }

                let url = `http://web.fc.utm.my/ttms/web_man_webservice_json.cgi?entity=pelajar&session_id=${adminSession.session_id}&sesi=${currentSesi}&semester=${currentSem}&limit=${fetchLimit}&offset=${fetchOffset}`;

                const response = await fetch(url);
                const students = await response.json();

                if (!Array.isArray(students)) {
                    throw new Error("Invalid response format");
                }

                if (currentSearchQuery) {
                    // Client-Side Filtering
                    const term = currentSearchQuery.toLowerCase();
                    allSearchResults = students.filter(s =>
                        (s.nama && s.nama.toLowerCase().includes(term)) ||
                        (s.no_matrik && s.no_matrik.toLowerCase().includes(term))
                    );

                    // Reset to page 1 of results
                    // calculate offset for local pagination based on 'currentPage'
                    // Actually, if we just typed, currentPage is 1. If we paginate search results, we need logic.
                    renderSearchResults();
                    updatePagination(allSearchResults.length, true); // Pass true for isSearch
                } else {
                    // Normal Browsing
                    renderTable(students);
                    updatePagination(students.length, false); // Pass false for isSearch
                }

            } catch (err) {
                console.error(err);
                $('#studentTableBody').html(`<tr><td colspan="5" style="text-align:center; color:red;">${currentSearchQuery ? "Search failed (Network/API Error)." : "Error loading students."}</td></tr>`);
            }
        }

        function renderSearchResults() {
            // Slice the global 'allSearchResults' based on currentPage
            const start = (currentPage - 1) * limit;
            const end = start + limit;
            const pageSlice = allSearchResults.slice(start, end);

            // Render this slice
            // We need to pass the 'start' index to renderTable so the row numbers are correct (global index)
            renderTable(pageSlice, start);
        }

        function renderTable(students, startIndex = offset) {
            const tbody = $('#studentTableBody');
            tbody.empty();

            if (students.length === 0) {
                tbody.html(`<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">
                    ${currentSearchQuery ? "No matches found." : "No students found."}
                </td></tr>`);
                return;
            }

            students.forEach((s, index) => {
                const row = `
                    <tr>
                        <td style="color:var(--text-muted); font-size:0.85rem;">${startIndex + index + 1}</td>
                        <td>
                            <div style="font-weight:600; color:var(--text-main);">${s.nama}</div>
                        </td>
                        <td>
                             <span style="font-weight:600;">${s.tahun_kursus}</span> 
                             <span style="color:var(--text-muted); margin-left:4px;">${s.kod_kursus}</span>
                        </td>
                        <td><span class="badge badge-primary">${s.kod_fakulti}</span></td>
                        <td style="text-align: center;">
                            <a href="#" style="font-weight:600; text-decoration:underline; color:#2563eb;">
                                ${s.bil_subjek}
                            </a>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        let currentPage = 1;

        function updatePagination(count, isSearch = false) {
            const container = $('#paginationContainer');
            container.empty();

            let totalPages = 1;
            let start = 0;
            let end = 0;

            if (isSearch) {
                // Client-side pagination based on total results
                totalPages = Math.ceil(count / limit);
                if (totalPages === 0) totalPages = 1;

                start = (currentPage - 1) * limit + 1;
                end = Math.min(start + limit - 1, count);
                if (count === 0) { start = 0; end = 0; }

                $('#startIdx').text(start);
                $('#endIdx').text(end);
            } else {
                // Server-side browsing (Unknown total)
                // count here is the number of items fetched (e.g., 20)
                start = offset + 1;
                end = offset + count;
                $('#startIdx').text(start);
                $('#endIdx').text(end);
            }

            // Button Rendering Logic
            // If search, we know total pages. If browse, we use sliding window.

            const prevBtn = $('<button class="page-num"><i class="fa fa-angle-left"></i></button>');
            if (currentPage === 1) prevBtn.prop('disabled', true);
            prevBtn.click(() => goToPage(currentPage - 1));
            container.append(prevBtn);

            let startPage, endPage;

            if (isSearch) {
                // Classic pagination with ellipsis if needed (simplified: show window)
                startPage = Math.max(1, currentPage - 2);
                endPage = Math.min(totalPages, currentPage + 2);

                // Adjust if near ends
                if (endPage - startPage < 4) {
                    if (startPage === 1) endPage = Math.min(totalPages, 5);
                    else if (endPage === totalPages) startPage = Math.max(1, totalPages - 4);
                }
            } else {
                // Browse Mode
                startPage = Math.max(1, currentPage - 2);
                endPage = currentPage + 2;
                // Detection if last page
                if (count < limit) endPage = currentPage;
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = $(`<button class="page-num">${i}</button>`);
                if (i === currentPage) btn.addClass('active');
                btn.click(() => goToPage(i));
                container.append(btn);
            }

            const nextBtn = $('<button class="page-num"><i class="fa fa-angle-right"></i></button>');
            if (isSearch) {
                if (currentPage >= totalPages) nextBtn.prop('disabled', true);
            } else {
                if (count < limit) nextBtn.prop('disabled', true);
            }

            nextBtn.click(() => goToPage(currentPage + 1));
            container.append(nextBtn);
        }

        function goToPage(pageNum) {
            if (pageNum < 1) return;
            currentPage = pageNum;

            if (currentSearchQuery) {
                // Client-side navigation (No fetch)
                renderSearchResults();
                // We need to re-render pagination to update active button
                // But updatePagination needs 'count'. 
                updatePagination(allSearchResults.length, true);
            } else {
                // Server-side navigation
                offset = (pageNum - 1) * limit;
                loadStudents();
            }
        }

        // Search Handler (Debounced or Enter)
        let searchTimeout;

        $('#studentSearch').on('keyup', function (e) {
            const value = $(this).val().trim();

            // If Enter key or empty (clear)
            if (e.key === 'Enter' || value.length === 0) {
                clearTimeout(searchTimeout);
                // Reset to page 1 for search
                offset = 0;
                currentPage = 1;
                currentSearchQuery = value;
                loadStudents();
                return;
            }

            // Debounce for typing
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                offset = 0;
                currentPage = 1;
                currentSearchQuery = value;
                loadStudents();
            }, 800); // Wait 800ms after typing stops
        });

        // Start
        init();
    })();
</script>

</html>